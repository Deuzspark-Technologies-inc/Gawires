<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Source of the Rust file `&#x2F;home&#x2F;runner&#x2F;.cargo&#x2F;registry&#x2F;src&#x2F;github.com-1ecc6299db9ec823&#x2F;interprocess-1.1.1&#x2F;src&#x2F;os&#x2F;windows&#x2F;named_pipe.rs`."><meta name="keywords" content="rust, rustlang, rust-lang"><title>named_pipe.rs - source</title><link rel="stylesheet" type="text/css" href="../../../../normalize.css"><link rel="stylesheet" type="text/css" href="../../../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../../../../light.css"  id="themeStyle"><link rel="stylesheet" type="text/css" href="../../../../dark.css" disabled ><link rel="stylesheet" type="text/css" href="../../../../ayu.css" disabled ><script id="default-settings" ></script><script src="../../../../storage.js"></script><script src="../../../../crates.js"></script><noscript><link rel="stylesheet" href="../../../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../../../favicon.svg"><style type="text/css">#crate-search{background-image:url("../../../../down-arrow.svg");}</style></head><body class="rustdoc source"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu" role="button">&#9776;</div><a href='../../../../interprocess/index.html'><div class='logo-container rust-logo'><img src='../../../../rust-logo.png' alt='logo'></div></a></nav><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu" title="themes"><img width="18" height="18" alt="Pick another theme!" src="../../../../brush.svg"></button><div id="theme-choices" role="menu"></div></div><nav class="sub"><form class="search-form"><div class="search-container"><div><select id="crate-search"><option value="All crates">All crates</option></select><input class="search-input" name="search" disabled autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"></div><button type="button" id="help-button" title="help">?</button><a id="settings-menu" href="../../../../settings.html" title="settings"><img width="18" height="18" alt="Change settings" src="../../../../wheel.svg"></a></div></form></nav><section id="main" class="content"><div class="example-wrap"><pre class="line-numbers"><span id="1">   1</span>
<span id="2">   2</span>
<span id="3">   3</span>
<span id="4">   4</span>
<span id="5">   5</span>
<span id="6">   6</span>
<span id="7">   7</span>
<span id="8">   8</span>
<span id="9">   9</span>
<span id="10">  10</span>
<span id="11">  11</span>
<span id="12">  12</span>
<span id="13">  13</span>
<span id="14">  14</span>
<span id="15">  15</span>
<span id="16">  16</span>
<span id="17">  17</span>
<span id="18">  18</span>
<span id="19">  19</span>
<span id="20">  20</span>
<span id="21">  21</span>
<span id="22">  22</span>
<span id="23">  23</span>
<span id="24">  24</span>
<span id="25">  25</span>
<span id="26">  26</span>
<span id="27">  27</span>
<span id="28">  28</span>
<span id="29">  29</span>
<span id="30">  30</span>
<span id="31">  31</span>
<span id="32">  32</span>
<span id="33">  33</span>
<span id="34">  34</span>
<span id="35">  35</span>
<span id="36">  36</span>
<span id="37">  37</span>
<span id="38">  38</span>
<span id="39">  39</span>
<span id="40">  40</span>
<span id="41">  41</span>
<span id="42">  42</span>
<span id="43">  43</span>
<span id="44">  44</span>
<span id="45">  45</span>
<span id="46">  46</span>
<span id="47">  47</span>
<span id="48">  48</span>
<span id="49">  49</span>
<span id="50">  50</span>
<span id="51">  51</span>
<span id="52">  52</span>
<span id="53">  53</span>
<span id="54">  54</span>
<span id="55">  55</span>
<span id="56">  56</span>
<span id="57">  57</span>
<span id="58">  58</span>
<span id="59">  59</span>
<span id="60">  60</span>
<span id="61">  61</span>
<span id="62">  62</span>
<span id="63">  63</span>
<span id="64">  64</span>
<span id="65">  65</span>
<span id="66">  66</span>
<span id="67">  67</span>
<span id="68">  68</span>
<span id="69">  69</span>
<span id="70">  70</span>
<span id="71">  71</span>
<span id="72">  72</span>
<span id="73">  73</span>
<span id="74">  74</span>
<span id="75">  75</span>
<span id="76">  76</span>
<span id="77">  77</span>
<span id="78">  78</span>
<span id="79">  79</span>
<span id="80">  80</span>
<span id="81">  81</span>
<span id="82">  82</span>
<span id="83">  83</span>
<span id="84">  84</span>
<span id="85">  85</span>
<span id="86">  86</span>
<span id="87">  87</span>
<span id="88">  88</span>
<span id="89">  89</span>
<span id="90">  90</span>
<span id="91">  91</span>
<span id="92">  92</span>
<span id="93">  93</span>
<span id="94">  94</span>
<span id="95">  95</span>
<span id="96">  96</span>
<span id="97">  97</span>
<span id="98">  98</span>
<span id="99">  99</span>
<span id="100"> 100</span>
<span id="101"> 101</span>
<span id="102"> 102</span>
<span id="103"> 103</span>
<span id="104"> 104</span>
<span id="105"> 105</span>
<span id="106"> 106</span>
<span id="107"> 107</span>
<span id="108"> 108</span>
<span id="109"> 109</span>
<span id="110"> 110</span>
<span id="111"> 111</span>
<span id="112"> 112</span>
<span id="113"> 113</span>
<span id="114"> 114</span>
<span id="115"> 115</span>
<span id="116"> 116</span>
<span id="117"> 117</span>
<span id="118"> 118</span>
<span id="119"> 119</span>
<span id="120"> 120</span>
<span id="121"> 121</span>
<span id="122"> 122</span>
<span id="123"> 123</span>
<span id="124"> 124</span>
<span id="125"> 125</span>
<span id="126"> 126</span>
<span id="127"> 127</span>
<span id="128"> 128</span>
<span id="129"> 129</span>
<span id="130"> 130</span>
<span id="131"> 131</span>
<span id="132"> 132</span>
<span id="133"> 133</span>
<span id="134"> 134</span>
<span id="135"> 135</span>
<span id="136"> 136</span>
<span id="137"> 137</span>
<span id="138"> 138</span>
<span id="139"> 139</span>
<span id="140"> 140</span>
<span id="141"> 141</span>
<span id="142"> 142</span>
<span id="143"> 143</span>
<span id="144"> 144</span>
<span id="145"> 145</span>
<span id="146"> 146</span>
<span id="147"> 147</span>
<span id="148"> 148</span>
<span id="149"> 149</span>
<span id="150"> 150</span>
<span id="151"> 151</span>
<span id="152"> 152</span>
<span id="153"> 153</span>
<span id="154"> 154</span>
<span id="155"> 155</span>
<span id="156"> 156</span>
<span id="157"> 157</span>
<span id="158"> 158</span>
<span id="159"> 159</span>
<span id="160"> 160</span>
<span id="161"> 161</span>
<span id="162"> 162</span>
<span id="163"> 163</span>
<span id="164"> 164</span>
<span id="165"> 165</span>
<span id="166"> 166</span>
<span id="167"> 167</span>
<span id="168"> 168</span>
<span id="169"> 169</span>
<span id="170"> 170</span>
<span id="171"> 171</span>
<span id="172"> 172</span>
<span id="173"> 173</span>
<span id="174"> 174</span>
<span id="175"> 175</span>
<span id="176"> 176</span>
<span id="177"> 177</span>
<span id="178"> 178</span>
<span id="179"> 179</span>
<span id="180"> 180</span>
<span id="181"> 181</span>
<span id="182"> 182</span>
<span id="183"> 183</span>
<span id="184"> 184</span>
<span id="185"> 185</span>
<span id="186"> 186</span>
<span id="187"> 187</span>
<span id="188"> 188</span>
<span id="189"> 189</span>
<span id="190"> 190</span>
<span id="191"> 191</span>
<span id="192"> 192</span>
<span id="193"> 193</span>
<span id="194"> 194</span>
<span id="195"> 195</span>
<span id="196"> 196</span>
<span id="197"> 197</span>
<span id="198"> 198</span>
<span id="199"> 199</span>
<span id="200"> 200</span>
<span id="201"> 201</span>
<span id="202"> 202</span>
<span id="203"> 203</span>
<span id="204"> 204</span>
<span id="205"> 205</span>
<span id="206"> 206</span>
<span id="207"> 207</span>
<span id="208"> 208</span>
<span id="209"> 209</span>
<span id="210"> 210</span>
<span id="211"> 211</span>
<span id="212"> 212</span>
<span id="213"> 213</span>
<span id="214"> 214</span>
<span id="215"> 215</span>
<span id="216"> 216</span>
<span id="217"> 217</span>
<span id="218"> 218</span>
<span id="219"> 219</span>
<span id="220"> 220</span>
<span id="221"> 221</span>
<span id="222"> 222</span>
<span id="223"> 223</span>
<span id="224"> 224</span>
<span id="225"> 225</span>
<span id="226"> 226</span>
<span id="227"> 227</span>
<span id="228"> 228</span>
<span id="229"> 229</span>
<span id="230"> 230</span>
<span id="231"> 231</span>
<span id="232"> 232</span>
<span id="233"> 233</span>
<span id="234"> 234</span>
<span id="235"> 235</span>
<span id="236"> 236</span>
<span id="237"> 237</span>
<span id="238"> 238</span>
<span id="239"> 239</span>
<span id="240"> 240</span>
<span id="241"> 241</span>
<span id="242"> 242</span>
<span id="243"> 243</span>
<span id="244"> 244</span>
<span id="245"> 245</span>
<span id="246"> 246</span>
<span id="247"> 247</span>
<span id="248"> 248</span>
<span id="249"> 249</span>
<span id="250"> 250</span>
<span id="251"> 251</span>
<span id="252"> 252</span>
<span id="253"> 253</span>
<span id="254"> 254</span>
<span id="255"> 255</span>
<span id="256"> 256</span>
<span id="257"> 257</span>
<span id="258"> 258</span>
<span id="259"> 259</span>
<span id="260"> 260</span>
<span id="261"> 261</span>
<span id="262"> 262</span>
<span id="263"> 263</span>
<span id="264"> 264</span>
<span id="265"> 265</span>
<span id="266"> 266</span>
<span id="267"> 267</span>
<span id="268"> 268</span>
<span id="269"> 269</span>
<span id="270"> 270</span>
<span id="271"> 271</span>
<span id="272"> 272</span>
<span id="273"> 273</span>
<span id="274"> 274</span>
<span id="275"> 275</span>
<span id="276"> 276</span>
<span id="277"> 277</span>
<span id="278"> 278</span>
<span id="279"> 279</span>
<span id="280"> 280</span>
<span id="281"> 281</span>
<span id="282"> 282</span>
<span id="283"> 283</span>
<span id="284"> 284</span>
<span id="285"> 285</span>
<span id="286"> 286</span>
<span id="287"> 287</span>
<span id="288"> 288</span>
<span id="289"> 289</span>
<span id="290"> 290</span>
<span id="291"> 291</span>
<span id="292"> 292</span>
<span id="293"> 293</span>
<span id="294"> 294</span>
<span id="295"> 295</span>
<span id="296"> 296</span>
<span id="297"> 297</span>
<span id="298"> 298</span>
<span id="299"> 299</span>
<span id="300"> 300</span>
<span id="301"> 301</span>
<span id="302"> 302</span>
<span id="303"> 303</span>
<span id="304"> 304</span>
<span id="305"> 305</span>
<span id="306"> 306</span>
<span id="307"> 307</span>
<span id="308"> 308</span>
<span id="309"> 309</span>
<span id="310"> 310</span>
<span id="311"> 311</span>
<span id="312"> 312</span>
<span id="313"> 313</span>
<span id="314"> 314</span>
<span id="315"> 315</span>
<span id="316"> 316</span>
<span id="317"> 317</span>
<span id="318"> 318</span>
<span id="319"> 319</span>
<span id="320"> 320</span>
<span id="321"> 321</span>
<span id="322"> 322</span>
<span id="323"> 323</span>
<span id="324"> 324</span>
<span id="325"> 325</span>
<span id="326"> 326</span>
<span id="327"> 327</span>
<span id="328"> 328</span>
<span id="329"> 329</span>
<span id="330"> 330</span>
<span id="331"> 331</span>
<span id="332"> 332</span>
<span id="333"> 333</span>
<span id="334"> 334</span>
<span id="335"> 335</span>
<span id="336"> 336</span>
<span id="337"> 337</span>
<span id="338"> 338</span>
<span id="339"> 339</span>
<span id="340"> 340</span>
<span id="341"> 341</span>
<span id="342"> 342</span>
<span id="343"> 343</span>
<span id="344"> 344</span>
<span id="345"> 345</span>
<span id="346"> 346</span>
<span id="347"> 347</span>
<span id="348"> 348</span>
<span id="349"> 349</span>
<span id="350"> 350</span>
<span id="351"> 351</span>
<span id="352"> 352</span>
<span id="353"> 353</span>
<span id="354"> 354</span>
<span id="355"> 355</span>
<span id="356"> 356</span>
<span id="357"> 357</span>
<span id="358"> 358</span>
<span id="359"> 359</span>
<span id="360"> 360</span>
<span id="361"> 361</span>
<span id="362"> 362</span>
<span id="363"> 363</span>
<span id="364"> 364</span>
<span id="365"> 365</span>
<span id="366"> 366</span>
<span id="367"> 367</span>
<span id="368"> 368</span>
<span id="369"> 369</span>
<span id="370"> 370</span>
<span id="371"> 371</span>
<span id="372"> 372</span>
<span id="373"> 373</span>
<span id="374"> 374</span>
<span id="375"> 375</span>
<span id="376"> 376</span>
<span id="377"> 377</span>
<span id="378"> 378</span>
<span id="379"> 379</span>
<span id="380"> 380</span>
<span id="381"> 381</span>
<span id="382"> 382</span>
<span id="383"> 383</span>
<span id="384"> 384</span>
<span id="385"> 385</span>
<span id="386"> 386</span>
<span id="387"> 387</span>
<span id="388"> 388</span>
<span id="389"> 389</span>
<span id="390"> 390</span>
<span id="391"> 391</span>
<span id="392"> 392</span>
<span id="393"> 393</span>
<span id="394"> 394</span>
<span id="395"> 395</span>
<span id="396"> 396</span>
<span id="397"> 397</span>
<span id="398"> 398</span>
<span id="399"> 399</span>
<span id="400"> 400</span>
<span id="401"> 401</span>
<span id="402"> 402</span>
<span id="403"> 403</span>
<span id="404"> 404</span>
<span id="405"> 405</span>
<span id="406"> 406</span>
<span id="407"> 407</span>
<span id="408"> 408</span>
<span id="409"> 409</span>
<span id="410"> 410</span>
<span id="411"> 411</span>
<span id="412"> 412</span>
<span id="413"> 413</span>
<span id="414"> 414</span>
<span id="415"> 415</span>
<span id="416"> 416</span>
<span id="417"> 417</span>
<span id="418"> 418</span>
<span id="419"> 419</span>
<span id="420"> 420</span>
<span id="421"> 421</span>
<span id="422"> 422</span>
<span id="423"> 423</span>
<span id="424"> 424</span>
<span id="425"> 425</span>
<span id="426"> 426</span>
<span id="427"> 427</span>
<span id="428"> 428</span>
<span id="429"> 429</span>
<span id="430"> 430</span>
<span id="431"> 431</span>
<span id="432"> 432</span>
<span id="433"> 433</span>
<span id="434"> 434</span>
<span id="435"> 435</span>
<span id="436"> 436</span>
<span id="437"> 437</span>
<span id="438"> 438</span>
<span id="439"> 439</span>
<span id="440"> 440</span>
<span id="441"> 441</span>
<span id="442"> 442</span>
<span id="443"> 443</span>
<span id="444"> 444</span>
<span id="445"> 445</span>
<span id="446"> 446</span>
<span id="447"> 447</span>
<span id="448"> 448</span>
<span id="449"> 449</span>
<span id="450"> 450</span>
<span id="451"> 451</span>
<span id="452"> 452</span>
<span id="453"> 453</span>
<span id="454"> 454</span>
<span id="455"> 455</span>
<span id="456"> 456</span>
<span id="457"> 457</span>
<span id="458"> 458</span>
<span id="459"> 459</span>
<span id="460"> 460</span>
<span id="461"> 461</span>
<span id="462"> 462</span>
<span id="463"> 463</span>
<span id="464"> 464</span>
<span id="465"> 465</span>
<span id="466"> 466</span>
<span id="467"> 467</span>
<span id="468"> 468</span>
<span id="469"> 469</span>
<span id="470"> 470</span>
<span id="471"> 471</span>
<span id="472"> 472</span>
<span id="473"> 473</span>
<span id="474"> 474</span>
<span id="475"> 475</span>
<span id="476"> 476</span>
<span id="477"> 477</span>
<span id="478"> 478</span>
<span id="479"> 479</span>
<span id="480"> 480</span>
<span id="481"> 481</span>
<span id="482"> 482</span>
<span id="483"> 483</span>
<span id="484"> 484</span>
<span id="485"> 485</span>
<span id="486"> 486</span>
<span id="487"> 487</span>
<span id="488"> 488</span>
<span id="489"> 489</span>
<span id="490"> 490</span>
<span id="491"> 491</span>
<span id="492"> 492</span>
<span id="493"> 493</span>
<span id="494"> 494</span>
<span id="495"> 495</span>
<span id="496"> 496</span>
<span id="497"> 497</span>
<span id="498"> 498</span>
<span id="499"> 499</span>
<span id="500"> 500</span>
<span id="501"> 501</span>
<span id="502"> 502</span>
<span id="503"> 503</span>
<span id="504"> 504</span>
<span id="505"> 505</span>
<span id="506"> 506</span>
<span id="507"> 507</span>
<span id="508"> 508</span>
<span id="509"> 509</span>
<span id="510"> 510</span>
<span id="511"> 511</span>
<span id="512"> 512</span>
<span id="513"> 513</span>
<span id="514"> 514</span>
<span id="515"> 515</span>
<span id="516"> 516</span>
<span id="517"> 517</span>
<span id="518"> 518</span>
<span id="519"> 519</span>
<span id="520"> 520</span>
<span id="521"> 521</span>
<span id="522"> 522</span>
<span id="523"> 523</span>
<span id="524"> 524</span>
<span id="525"> 525</span>
<span id="526"> 526</span>
<span id="527"> 527</span>
<span id="528"> 528</span>
<span id="529"> 529</span>
<span id="530"> 530</span>
<span id="531"> 531</span>
<span id="532"> 532</span>
<span id="533"> 533</span>
<span id="534"> 534</span>
<span id="535"> 535</span>
<span id="536"> 536</span>
<span id="537"> 537</span>
<span id="538"> 538</span>
<span id="539"> 539</span>
<span id="540"> 540</span>
<span id="541"> 541</span>
<span id="542"> 542</span>
<span id="543"> 543</span>
<span id="544"> 544</span>
<span id="545"> 545</span>
<span id="546"> 546</span>
<span id="547"> 547</span>
<span id="548"> 548</span>
<span id="549"> 549</span>
<span id="550"> 550</span>
<span id="551"> 551</span>
<span id="552"> 552</span>
<span id="553"> 553</span>
<span id="554"> 554</span>
<span id="555"> 555</span>
<span id="556"> 556</span>
<span id="557"> 557</span>
<span id="558"> 558</span>
<span id="559"> 559</span>
<span id="560"> 560</span>
<span id="561"> 561</span>
<span id="562"> 562</span>
<span id="563"> 563</span>
<span id="564"> 564</span>
<span id="565"> 565</span>
<span id="566"> 566</span>
<span id="567"> 567</span>
<span id="568"> 568</span>
<span id="569"> 569</span>
<span id="570"> 570</span>
<span id="571"> 571</span>
<span id="572"> 572</span>
<span id="573"> 573</span>
<span id="574"> 574</span>
<span id="575"> 575</span>
<span id="576"> 576</span>
<span id="577"> 577</span>
<span id="578"> 578</span>
<span id="579"> 579</span>
<span id="580"> 580</span>
<span id="581"> 581</span>
<span id="582"> 582</span>
<span id="583"> 583</span>
<span id="584"> 584</span>
<span id="585"> 585</span>
<span id="586"> 586</span>
<span id="587"> 587</span>
<span id="588"> 588</span>
<span id="589"> 589</span>
<span id="590"> 590</span>
<span id="591"> 591</span>
<span id="592"> 592</span>
<span id="593"> 593</span>
<span id="594"> 594</span>
<span id="595"> 595</span>
<span id="596"> 596</span>
<span id="597"> 597</span>
<span id="598"> 598</span>
<span id="599"> 599</span>
<span id="600"> 600</span>
<span id="601"> 601</span>
<span id="602"> 602</span>
<span id="603"> 603</span>
<span id="604"> 604</span>
<span id="605"> 605</span>
<span id="606"> 606</span>
<span id="607"> 607</span>
<span id="608"> 608</span>
<span id="609"> 609</span>
<span id="610"> 610</span>
<span id="611"> 611</span>
<span id="612"> 612</span>
<span id="613"> 613</span>
<span id="614"> 614</span>
<span id="615"> 615</span>
<span id="616"> 616</span>
<span id="617"> 617</span>
<span id="618"> 618</span>
<span id="619"> 619</span>
<span id="620"> 620</span>
<span id="621"> 621</span>
<span id="622"> 622</span>
<span id="623"> 623</span>
<span id="624"> 624</span>
<span id="625"> 625</span>
<span id="626"> 626</span>
<span id="627"> 627</span>
<span id="628"> 628</span>
<span id="629"> 629</span>
<span id="630"> 630</span>
<span id="631"> 631</span>
<span id="632"> 632</span>
<span id="633"> 633</span>
<span id="634"> 634</span>
<span id="635"> 635</span>
<span id="636"> 636</span>
<span id="637"> 637</span>
<span id="638"> 638</span>
<span id="639"> 639</span>
<span id="640"> 640</span>
<span id="641"> 641</span>
<span id="642"> 642</span>
<span id="643"> 643</span>
<span id="644"> 644</span>
<span id="645"> 645</span>
<span id="646"> 646</span>
<span id="647"> 647</span>
<span id="648"> 648</span>
<span id="649"> 649</span>
<span id="650"> 650</span>
<span id="651"> 651</span>
<span id="652"> 652</span>
<span id="653"> 653</span>
<span id="654"> 654</span>
<span id="655"> 655</span>
<span id="656"> 656</span>
<span id="657"> 657</span>
<span id="658"> 658</span>
<span id="659"> 659</span>
<span id="660"> 660</span>
<span id="661"> 661</span>
<span id="662"> 662</span>
<span id="663"> 663</span>
<span id="664"> 664</span>
<span id="665"> 665</span>
<span id="666"> 666</span>
<span id="667"> 667</span>
<span id="668"> 668</span>
<span id="669"> 669</span>
<span id="670"> 670</span>
<span id="671"> 671</span>
<span id="672"> 672</span>
<span id="673"> 673</span>
<span id="674"> 674</span>
<span id="675"> 675</span>
<span id="676"> 676</span>
<span id="677"> 677</span>
<span id="678"> 678</span>
<span id="679"> 679</span>
<span id="680"> 680</span>
<span id="681"> 681</span>
<span id="682"> 682</span>
<span id="683"> 683</span>
<span id="684"> 684</span>
<span id="685"> 685</span>
<span id="686"> 686</span>
<span id="687"> 687</span>
<span id="688"> 688</span>
<span id="689"> 689</span>
<span id="690"> 690</span>
<span id="691"> 691</span>
<span id="692"> 692</span>
<span id="693"> 693</span>
<span id="694"> 694</span>
<span id="695"> 695</span>
<span id="696"> 696</span>
<span id="697"> 697</span>
<span id="698"> 698</span>
<span id="699"> 699</span>
<span id="700"> 700</span>
<span id="701"> 701</span>
<span id="702"> 702</span>
<span id="703"> 703</span>
<span id="704"> 704</span>
<span id="705"> 705</span>
<span id="706"> 706</span>
<span id="707"> 707</span>
<span id="708"> 708</span>
<span id="709"> 709</span>
<span id="710"> 710</span>
<span id="711"> 711</span>
<span id="712"> 712</span>
<span id="713"> 713</span>
<span id="714"> 714</span>
<span id="715"> 715</span>
<span id="716"> 716</span>
<span id="717"> 717</span>
<span id="718"> 718</span>
<span id="719"> 719</span>
<span id="720"> 720</span>
<span id="721"> 721</span>
<span id="722"> 722</span>
<span id="723"> 723</span>
<span id="724"> 724</span>
<span id="725"> 725</span>
<span id="726"> 726</span>
<span id="727"> 727</span>
<span id="728"> 728</span>
<span id="729"> 729</span>
<span id="730"> 730</span>
<span id="731"> 731</span>
<span id="732"> 732</span>
<span id="733"> 733</span>
<span id="734"> 734</span>
<span id="735"> 735</span>
<span id="736"> 736</span>
<span id="737"> 737</span>
<span id="738"> 738</span>
<span id="739"> 739</span>
<span id="740"> 740</span>
<span id="741"> 741</span>
<span id="742"> 742</span>
<span id="743"> 743</span>
<span id="744"> 744</span>
<span id="745"> 745</span>
<span id="746"> 746</span>
<span id="747"> 747</span>
<span id="748"> 748</span>
<span id="749"> 749</span>
<span id="750"> 750</span>
<span id="751"> 751</span>
<span id="752"> 752</span>
<span id="753"> 753</span>
<span id="754"> 754</span>
<span id="755"> 755</span>
<span id="756"> 756</span>
<span id="757"> 757</span>
<span id="758"> 758</span>
<span id="759"> 759</span>
<span id="760"> 760</span>
<span id="761"> 761</span>
<span id="762"> 762</span>
<span id="763"> 763</span>
<span id="764"> 764</span>
<span id="765"> 765</span>
<span id="766"> 766</span>
<span id="767"> 767</span>
<span id="768"> 768</span>
<span id="769"> 769</span>
<span id="770"> 770</span>
<span id="771"> 771</span>
<span id="772"> 772</span>
<span id="773"> 773</span>
<span id="774"> 774</span>
<span id="775"> 775</span>
<span id="776"> 776</span>
<span id="777"> 777</span>
<span id="778"> 778</span>
<span id="779"> 779</span>
<span id="780"> 780</span>
<span id="781"> 781</span>
<span id="782"> 782</span>
<span id="783"> 783</span>
<span id="784"> 784</span>
<span id="785"> 785</span>
<span id="786"> 786</span>
<span id="787"> 787</span>
<span id="788"> 788</span>
<span id="789"> 789</span>
<span id="790"> 790</span>
<span id="791"> 791</span>
<span id="792"> 792</span>
<span id="793"> 793</span>
<span id="794"> 794</span>
<span id="795"> 795</span>
<span id="796"> 796</span>
<span id="797"> 797</span>
<span id="798"> 798</span>
<span id="799"> 799</span>
<span id="800"> 800</span>
<span id="801"> 801</span>
<span id="802"> 802</span>
<span id="803"> 803</span>
<span id="804"> 804</span>
<span id="805"> 805</span>
<span id="806"> 806</span>
<span id="807"> 807</span>
<span id="808"> 808</span>
<span id="809"> 809</span>
<span id="810"> 810</span>
<span id="811"> 811</span>
<span id="812"> 812</span>
<span id="813"> 813</span>
<span id="814"> 814</span>
<span id="815"> 815</span>
<span id="816"> 816</span>
<span id="817"> 817</span>
<span id="818"> 818</span>
<span id="819"> 819</span>
<span id="820"> 820</span>
<span id="821"> 821</span>
<span id="822"> 822</span>
<span id="823"> 823</span>
<span id="824"> 824</span>
<span id="825"> 825</span>
<span id="826"> 826</span>
<span id="827"> 827</span>
<span id="828"> 828</span>
<span id="829"> 829</span>
<span id="830"> 830</span>
<span id="831"> 831</span>
<span id="832"> 832</span>
<span id="833"> 833</span>
<span id="834"> 834</span>
<span id="835"> 835</span>
<span id="836"> 836</span>
<span id="837"> 837</span>
<span id="838"> 838</span>
<span id="839"> 839</span>
<span id="840"> 840</span>
<span id="841"> 841</span>
<span id="842"> 842</span>
<span id="843"> 843</span>
<span id="844"> 844</span>
<span id="845"> 845</span>
<span id="846"> 846</span>
<span id="847"> 847</span>
<span id="848"> 848</span>
<span id="849"> 849</span>
<span id="850"> 850</span>
<span id="851"> 851</span>
<span id="852"> 852</span>
<span id="853"> 853</span>
<span id="854"> 854</span>
<span id="855"> 855</span>
<span id="856"> 856</span>
<span id="857"> 857</span>
<span id="858"> 858</span>
<span id="859"> 859</span>
<span id="860"> 860</span>
<span id="861"> 861</span>
<span id="862"> 862</span>
<span id="863"> 863</span>
<span id="864"> 864</span>
<span id="865"> 865</span>
<span id="866"> 866</span>
<span id="867"> 867</span>
<span id="868"> 868</span>
<span id="869"> 869</span>
<span id="870"> 870</span>
<span id="871"> 871</span>
<span id="872"> 872</span>
<span id="873"> 873</span>
<span id="874"> 874</span>
<span id="875"> 875</span>
<span id="876"> 876</span>
<span id="877"> 877</span>
<span id="878"> 878</span>
<span id="879"> 879</span>
<span id="880"> 880</span>
<span id="881"> 881</span>
<span id="882"> 882</span>
<span id="883"> 883</span>
<span id="884"> 884</span>
<span id="885"> 885</span>
<span id="886"> 886</span>
<span id="887"> 887</span>
<span id="888"> 888</span>
<span id="889"> 889</span>
<span id="890"> 890</span>
<span id="891"> 891</span>
<span id="892"> 892</span>
<span id="893"> 893</span>
<span id="894"> 894</span>
<span id="895"> 895</span>
<span id="896"> 896</span>
<span id="897"> 897</span>
<span id="898"> 898</span>
<span id="899"> 899</span>
<span id="900"> 900</span>
<span id="901"> 901</span>
<span id="902"> 902</span>
<span id="903"> 903</span>
<span id="904"> 904</span>
<span id="905"> 905</span>
<span id="906"> 906</span>
<span id="907"> 907</span>
<span id="908"> 908</span>
<span id="909"> 909</span>
<span id="910"> 910</span>
<span id="911"> 911</span>
<span id="912"> 912</span>
<span id="913"> 913</span>
<span id="914"> 914</span>
<span id="915"> 915</span>
<span id="916"> 916</span>
<span id="917"> 917</span>
<span id="918"> 918</span>
<span id="919"> 919</span>
<span id="920"> 920</span>
<span id="921"> 921</span>
<span id="922"> 922</span>
<span id="923"> 923</span>
<span id="924"> 924</span>
<span id="925"> 925</span>
<span id="926"> 926</span>
<span id="927"> 927</span>
<span id="928"> 928</span>
<span id="929"> 929</span>
<span id="930"> 930</span>
<span id="931"> 931</span>
<span id="932"> 932</span>
<span id="933"> 933</span>
<span id="934"> 934</span>
<span id="935"> 935</span>
<span id="936"> 936</span>
<span id="937"> 937</span>
<span id="938"> 938</span>
<span id="939"> 939</span>
<span id="940"> 940</span>
<span id="941"> 941</span>
<span id="942"> 942</span>
<span id="943"> 943</span>
<span id="944"> 944</span>
<span id="945"> 945</span>
<span id="946"> 946</span>
<span id="947"> 947</span>
<span id="948"> 948</span>
<span id="949"> 949</span>
<span id="950"> 950</span>
<span id="951"> 951</span>
<span id="952"> 952</span>
<span id="953"> 953</span>
<span id="954"> 954</span>
<span id="955"> 955</span>
<span id="956"> 956</span>
<span id="957"> 957</span>
<span id="958"> 958</span>
<span id="959"> 959</span>
<span id="960"> 960</span>
<span id="961"> 961</span>
<span id="962"> 962</span>
<span id="963"> 963</span>
<span id="964"> 964</span>
<span id="965"> 965</span>
<span id="966"> 966</span>
<span id="967"> 967</span>
<span id="968"> 968</span>
<span id="969"> 969</span>
<span id="970"> 970</span>
<span id="971"> 971</span>
<span id="972"> 972</span>
<span id="973"> 973</span>
<span id="974"> 974</span>
<span id="975"> 975</span>
<span id="976"> 976</span>
<span id="977"> 977</span>
<span id="978"> 978</span>
<span id="979"> 979</span>
<span id="980"> 980</span>
<span id="981"> 981</span>
<span id="982"> 982</span>
<span id="983"> 983</span>
<span id="984"> 984</span>
<span id="985"> 985</span>
<span id="986"> 986</span>
<span id="987"> 987</span>
<span id="988"> 988</span>
<span id="989"> 989</span>
<span id="990"> 990</span>
<span id="991"> 991</span>
<span id="992"> 992</span>
<span id="993"> 993</span>
<span id="994"> 994</span>
<span id="995"> 995</span>
<span id="996"> 996</span>
<span id="997"> 997</span>
<span id="998"> 998</span>
<span id="999"> 999</span>
<span id="1000">1000</span>
<span id="1001">1001</span>
<span id="1002">1002</span>
<span id="1003">1003</span>
<span id="1004">1004</span>
<span id="1005">1005</span>
<span id="1006">1006</span>
<span id="1007">1007</span>
<span id="1008">1008</span>
<span id="1009">1009</span>
<span id="1010">1010</span>
<span id="1011">1011</span>
<span id="1012">1012</span>
<span id="1013">1013</span>
<span id="1014">1014</span>
<span id="1015">1015</span>
<span id="1016">1016</span>
<span id="1017">1017</span>
<span id="1018">1018</span>
<span id="1019">1019</span>
<span id="1020">1020</span>
<span id="1021">1021</span>
<span id="1022">1022</span>
<span id="1023">1023</span>
<span id="1024">1024</span>
<span id="1025">1025</span>
<span id="1026">1026</span>
<span id="1027">1027</span>
<span id="1028">1028</span>
<span id="1029">1029</span>
<span id="1030">1030</span>
<span id="1031">1031</span>
<span id="1032">1032</span>
<span id="1033">1033</span>
<span id="1034">1034</span>
<span id="1035">1035</span>
<span id="1036">1036</span>
<span id="1037">1037</span>
<span id="1038">1038</span>
<span id="1039">1039</span>
<span id="1040">1040</span>
<span id="1041">1041</span>
<span id="1042">1042</span>
<span id="1043">1043</span>
<span id="1044">1044</span>
<span id="1045">1045</span>
<span id="1046">1046</span>
<span id="1047">1047</span>
<span id="1048">1048</span>
<span id="1049">1049</span>
<span id="1050">1050</span>
<span id="1051">1051</span>
<span id="1052">1052</span>
<span id="1053">1053</span>
<span id="1054">1054</span>
<span id="1055">1055</span>
<span id="1056">1056</span>
<span id="1057">1057</span>
<span id="1058">1058</span>
<span id="1059">1059</span>
<span id="1060">1060</span>
<span id="1061">1061</span>
<span id="1062">1062</span>
<span id="1063">1063</span>
<span id="1064">1064</span>
<span id="1065">1065</span>
<span id="1066">1066</span>
<span id="1067">1067</span>
<span id="1068">1068</span>
<span id="1069">1069</span>
<span id="1070">1070</span>
<span id="1071">1071</span>
<span id="1072">1072</span>
<span id="1073">1073</span>
<span id="1074">1074</span>
<span id="1075">1075</span>
<span id="1076">1076</span>
<span id="1077">1077</span>
<span id="1078">1078</span>
<span id="1079">1079</span>
<span id="1080">1080</span>
<span id="1081">1081</span>
<span id="1082">1082</span>
<span id="1083">1083</span>
<span id="1084">1084</span>
<span id="1085">1085</span>
<span id="1086">1086</span>
<span id="1087">1087</span>
<span id="1088">1088</span>
<span id="1089">1089</span>
<span id="1090">1090</span>
<span id="1091">1091</span>
<span id="1092">1092</span>
<span id="1093">1093</span>
<span id="1094">1094</span>
<span id="1095">1095</span>
<span id="1096">1096</span>
<span id="1097">1097</span>
<span id="1098">1098</span>
<span id="1099">1099</span>
<span id="1100">1100</span>
<span id="1101">1101</span>
<span id="1102">1102</span>
<span id="1103">1103</span>
<span id="1104">1104</span>
<span id="1105">1105</span>
<span id="1106">1106</span>
<span id="1107">1107</span>
<span id="1108">1108</span>
<span id="1109">1109</span>
<span id="1110">1110</span>
<span id="1111">1111</span>
<span id="1112">1112</span>
<span id="1113">1113</span>
<span id="1114">1114</span>
<span id="1115">1115</span>
<span id="1116">1116</span>
<span id="1117">1117</span>
<span id="1118">1118</span>
<span id="1119">1119</span>
<span id="1120">1120</span>
<span id="1121">1121</span>
<span id="1122">1122</span>
<span id="1123">1123</span>
<span id="1124">1124</span>
<span id="1125">1125</span>
<span id="1126">1126</span>
<span id="1127">1127</span>
<span id="1128">1128</span>
<span id="1129">1129</span>
<span id="1130">1130</span>
<span id="1131">1131</span>
<span id="1132">1132</span>
<span id="1133">1133</span>
<span id="1134">1134</span>
<span id="1135">1135</span>
<span id="1136">1136</span>
<span id="1137">1137</span>
<span id="1138">1138</span>
<span id="1139">1139</span>
<span id="1140">1140</span>
<span id="1141">1141</span>
<span id="1142">1142</span>
<span id="1143">1143</span>
<span id="1144">1144</span>
<span id="1145">1145</span>
<span id="1146">1146</span>
<span id="1147">1147</span>
<span id="1148">1148</span>
<span id="1149">1149</span>
<span id="1150">1150</span>
<span id="1151">1151</span>
<span id="1152">1152</span>
<span id="1153">1153</span>
<span id="1154">1154</span>
<span id="1155">1155</span>
<span id="1156">1156</span>
<span id="1157">1157</span>
<span id="1158">1158</span>
<span id="1159">1159</span>
<span id="1160">1160</span>
<span id="1161">1161</span>
<span id="1162">1162</span>
<span id="1163">1163</span>
<span id="1164">1164</span>
<span id="1165">1165</span>
<span id="1166">1166</span>
<span id="1167">1167</span>
<span id="1168">1168</span>
<span id="1169">1169</span>
<span id="1170">1170</span>
<span id="1171">1171</span>
<span id="1172">1172</span>
<span id="1173">1173</span>
<span id="1174">1174</span>
<span id="1175">1175</span>
<span id="1176">1176</span>
<span id="1177">1177</span>
<span id="1178">1178</span>
<span id="1179">1179</span>
<span id="1180">1180</span>
<span id="1181">1181</span>
<span id="1182">1182</span>
<span id="1183">1183</span>
<span id="1184">1184</span>
<span id="1185">1185</span>
<span id="1186">1186</span>
<span id="1187">1187</span>
<span id="1188">1188</span>
<span id="1189">1189</span>
<span id="1190">1190</span>
<span id="1191">1191</span>
<span id="1192">1192</span>
<span id="1193">1193</span>
<span id="1194">1194</span>
<span id="1195">1195</span>
<span id="1196">1196</span>
<span id="1197">1197</span>
<span id="1198">1198</span>
<span id="1199">1199</span>
<span id="1200">1200</span>
<span id="1201">1201</span>
<span id="1202">1202</span>
<span id="1203">1203</span>
<span id="1204">1204</span>
<span id="1205">1205</span>
<span id="1206">1206</span>
<span id="1207">1207</span>
<span id="1208">1208</span>
<span id="1209">1209</span>
<span id="1210">1210</span>
<span id="1211">1211</span>
<span id="1212">1212</span>
<span id="1213">1213</span>
<span id="1214">1214</span>
<span id="1215">1215</span>
<span id="1216">1216</span>
<span id="1217">1217</span>
<span id="1218">1218</span>
<span id="1219">1219</span>
<span id="1220">1220</span>
<span id="1221">1221</span>
<span id="1222">1222</span>
<span id="1223">1223</span>
<span id="1224">1224</span>
<span id="1225">1225</span>
<span id="1226">1226</span>
<span id="1227">1227</span>
<span id="1228">1228</span>
<span id="1229">1229</span>
<span id="1230">1230</span>
<span id="1231">1231</span>
<span id="1232">1232</span>
<span id="1233">1233</span>
<span id="1234">1234</span>
<span id="1235">1235</span>
<span id="1236">1236</span>
<span id="1237">1237</span>
<span id="1238">1238</span>
<span id="1239">1239</span>
<span id="1240">1240</span>
<span id="1241">1241</span>
<span id="1242">1242</span>
<span id="1243">1243</span>
<span id="1244">1244</span>
<span id="1245">1245</span>
<span id="1246">1246</span>
<span id="1247">1247</span>
<span id="1248">1248</span>
<span id="1249">1249</span>
<span id="1250">1250</span>
<span id="1251">1251</span>
<span id="1252">1252</span>
<span id="1253">1253</span>
<span id="1254">1254</span>
<span id="1255">1255</span>
</pre><pre class="rust"><code><span class="doccomment">//! Support for named pipes on Windows.</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! ## Windows named pipes are not Unix named pipes</span>
<span class="doccomment">//! The term &quot;named pipe&quot; refers to completely different things in Unix and Windows. For this reason, Unix named pipes are referred to as &quot;FIFO files&quot; to avoid confusion with the more powerful Windows named pipes. In fact, the only common features for those two is that they both can be located using filesystem paths and they both use a stream interface. The simplest way to explain their differences is using a list:</span>
<span class="doccomment">//! - Windows named pipes are located on a separate filesystem (NPFS — **N**amed **P**ipe **F**ile**s**ystem), while Unix FIFO files live in the shared filesystem tree together with all other files</span>
<span class="doccomment">//!     - On Linux, the implementation of Unix domain sockets exposes a similar feature: by setting the first byte in the socket file path to `NULL` (`\0`), the socket is placed into a separate namespace instead of being placed on the filesystem; this is non-standard extension to POSIX and is not available on other Unix systems</span>
<span class="doccomment">//! - Windows named pipes have a server and an arbitrary number of clients, meaning that the separate processes connecting to a named pipe have separate connections to the server, while Unix FIFO files don&#39;t have the notion of a server or client and thus mix all data written into one sink from which the data is read by one process</span>
<span class="doccomment">//! - Windows named pipes can be used over the network, while a Unix FIFO file is still local even if created in a directory which is a mounted network filesystem</span>
<span class="doccomment">//! - Windows named pipes can maintain datagram boundaries, allowing both sides of the connection to operate on separate messages rather than on a byte stream, while FIFO files, like any other type of file, expose only a byte stream interface</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! If you carefully read through this list, you&#39;d notice how Windows named pipes are similar to Unix domain sockets. For this reason, the implementation of &quot;local sockets&quot; in the `local_socket` module of this crate uses named pipes on Windows and Ud-sockets on Unix.</span>

<span class="comment">// TODO improve docs, add examples</span>

<span class="kw">use</span> <span class="ident"><span class="kw">super</span>::imports</span>::<span class="kw-2">*</span>;
<span class="kw">use</span> <span class="kw">super</span>::{<span class="ident">AsRawHandle</span>, <span class="ident">FromRawHandle</span>, <span class="ident">IntoRawHandle</span>};
<span class="kw">use</span> <span class="ident">std</span>::{
    <span class="ident">borrow::Cow</span>,
    <span class="ident">convert</span>::{<span class="ident">TryFrom</span>, <span class="ident">TryInto</span>},
    <span class="ident">ffi</span>::{<span class="ident">OsStr</span>, <span class="ident">OsString</span>},
    <span class="ident">fmt</span>::{<span class="self">self</span>, <span class="ident">Debug</span>, <span class="ident">Formatter</span>},
    <span class="ident">io</span>::{<span class="self">self</span>, <span class="ident">Read</span>, <span class="ident">Write</span>},
    <span class="ident">marker::PhantomData</span>,
    <span class="ident">mem</span>,
    <span class="ident">num</span>::{<span class="ident">NonZeroU32</span>, <span class="ident">NonZeroU8</span>},
    <span class="ident">ptr</span>,
    <span class="ident">sync</span>::{
        <span class="ident">atomic</span>::{<span class="ident">AtomicBool</span>, <span class="ident">Ordering</span>},
        <span class="ident">Arc</span>, <span class="ident">RwLock</span>,
    },
};

<span class="kw">use</span> <span class="kw">crate</span>::{<span class="ident">PartialMsgWriteError</span>, <span class="ident">ReliableReadMsg</span>, <span class="ident">Sealed</span>};

<span class="kw">fn</span> <span class="ident">convert_path</span>(<span class="ident">osstr</span>: <span class="kw-2">&amp;</span><span class="ident">OsStr</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u16</span><span class="op">&gt;</span> {
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">path</span> <span class="op">=</span> <span class="ident">OsString::from</span>(<span class="string">r&quot;\\.\pipe\&quot;</span>);
    <span class="ident">path</span>.<span class="ident">push</span>(<span class="ident">osstr</span>);
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">path</span> <span class="op">=</span> <span class="ident">path</span>.<span class="ident">encode_wide</span>().<span class="ident">collect</span>::<span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u16</span><span class="op">&gt;</span><span class="op">&gt;</span>();
    <span class="ident">path</span>.<span class="ident">push</span>(<span class="number">0</span>); <span class="comment">// encode_wide does not include the terminating NULL, so we have to add it ourselves</span>
    <span class="ident">path</span>
}

<span class="doccomment">/// The server for a named pipe, listening for connections to clients and producing pipe streams.</span>
<span class="doccomment">///</span>
<span class="doccomment">/// The only way to create a `PipeListener` is to use [`PipeListenerOptions`]. See its documentation for more.</span>
<span class="doccomment">///</span>
<span class="doccomment">/// [`PipeListenerOptions`]: struct.PipeListenerOptions.html &quot; &quot;</span>
<span class="kw">pub</span> <span class="kw">struct</span> <span class="ident">PipeListener</span><span class="op">&lt;</span><span class="ident">Stream</span>: <span class="ident">PipeStream</span><span class="op">&gt;</span> {
    <span class="ident">config</span>: <span class="ident">PipeListenerOptions</span><span class="op">&lt;</span><span class="lifetime">&#39;static</span><span class="op">&gt;</span>, <span class="comment">// We need the options to create new instances</span>
    <span class="comment">// Store the nonblocking boolean separately to change it without mutable access</span>
    <span class="ident">nonblocking</span>: <span class="ident">AtomicBool</span>,
    <span class="ident">instances</span>: <span class="ident">RwLock</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Arc</span><span class="op">&lt;</span>(<span class="ident">PipeOps</span>, <span class="ident">AtomicBool</span>)<span class="op">&gt;</span><span class="op">&gt;</span><span class="op">&gt;</span>,
    <span class="ident">_phantom</span>: <span class="ident">PhantomData</span><span class="op">&lt;</span><span class="kw">fn</span>() <span class="op">-</span><span class="op">&gt;</span> <span class="ident">Stream</span><span class="op">&gt;</span>,
}
<span class="doccomment">/// An iterator that infinitely [`accept`]s connections on a [`PipeListener`].</span>
<span class="doccomment">///</span>
<span class="doccomment">/// This iterator is created by the [`incoming`] method on [`PipeListener`]. See its documentation for more.</span>
<span class="doccomment">///</span>
<span class="doccomment">/// [`PipeListener`]: struct.PipeListener.html &quot; &quot;</span>
<span class="doccomment">/// [`accept`]: struct.PipeListener.html#method.accept &quot; &quot;</span>
<span class="doccomment">/// [`incoming`]: struct.PipeListener.html#method.incoming &quot; &quot;</span>
<span class="kw">pub</span> <span class="kw">struct</span> <span class="ident">Incoming</span><span class="op">&lt;</span><span class="lifetime">&#39;a</span>, <span class="ident">Stream</span>: <span class="ident">PipeStream</span><span class="op">&gt;</span> {
    <span class="ident">listener</span>: <span class="kw-2">&amp;</span><span class="lifetime">&#39;a</span> <span class="ident">PipeListener</span><span class="op">&lt;</span><span class="ident">Stream</span><span class="op">&gt;</span>,
}
<span class="kw">impl</span><span class="op">&lt;</span><span class="lifetime">&#39;a</span>, <span class="ident">Stream</span>: <span class="ident">PipeStream</span><span class="op">&gt;</span> <span class="ident">Iterator</span> <span class="kw">for</span> <span class="ident">Incoming</span><span class="op">&lt;</span><span class="lifetime">&#39;a</span>, <span class="ident">Stream</span><span class="op">&gt;</span> {
    <span class="kw">type</span> <span class="ident">Item</span> <span class="op">=</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="ident">Stream</span><span class="op">&gt;</span>;
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">fn</span> <span class="ident">next</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident"><span class="self">Self</span>::Item</span><span class="op">&gt;</span> {
        <span class="prelude-val">Some</span>(<span class="self">self</span>.<span class="ident">listener</span>.<span class="ident">accept</span>())
    }
}
<span class="kw">impl</span><span class="op">&lt;</span><span class="lifetime">&#39;a</span>, <span class="ident">Stream</span>: <span class="ident">PipeStream</span><span class="op">&gt;</span> <span class="ident">IntoIterator</span> <span class="kw">for</span> <span class="kw-2">&amp;</span><span class="lifetime">&#39;a</span> <span class="ident">PipeListener</span><span class="op">&lt;</span><span class="ident">Stream</span><span class="op">&gt;</span> {
    <span class="kw">type</span> <span class="ident">IntoIter</span> <span class="op">=</span> <span class="ident">Incoming</span><span class="op">&lt;</span><span class="lifetime">&#39;a</span>, <span class="ident">Stream</span><span class="op">&gt;</span>;
    <span class="kw">type</span> <span class="ident">Item</span> <span class="op">=</span> <span class="op">&lt;</span><span class="ident">Incoming</span><span class="op">&lt;</span><span class="lifetime">&#39;a</span>, <span class="ident">Stream</span><span class="op">&gt;</span> <span class="kw">as</span> <span class="ident">Iterator</span><span class="op">&gt;</span><span class="ident">::Item</span>;
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">fn</span> <span class="ident">into_iter</span>(<span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident"><span class="self">Self</span>::IntoIter</span> {
        <span class="self">self</span>.<span class="ident">incoming</span>()
    }
}
<span class="kw">impl</span><span class="op">&lt;</span><span class="ident">Stream</span>: <span class="ident">PipeStream</span><span class="op">&gt;</span> <span class="ident">PipeListener</span><span class="op">&lt;</span><span class="ident">Stream</span><span class="op">&gt;</span> {
    <span class="doccomment">/// Blocks until a client connects to the named pipe, creating a `Stream` to communicate with the pipe.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// See `incoming` for an iterator version of this.</span>
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">accept</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="ident">Stream</span><span class="op">&gt;</span> {
        <span class="kw">let</span> <span class="ident">instance</span> <span class="op">=</span> <span class="self">self</span>.<span class="ident">alloc_instance</span>()<span class="question-mark">?</span>;
        <span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">connect</span>()<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(<span class="ident">Stream::from</span>(<span class="ident">instance</span>))
    }
    <span class="doccomment">/// Creates an iterator which accepts connections from clients, blocking each time `next()` is called until one connects.</span>
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">incoming</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">Incoming</span><span class="op">&lt;</span><span class="lifetime">&#39;_</span>, <span class="ident">Stream</span><span class="op">&gt;</span> {
        <span class="ident">Incoming</span> { <span class="ident">listener</span>: <span class="self">self</span> }
    }
    <span class="doccomment">/// Enables or disables the nonblocking mode for all existing instances of the listener and future ones. By default, it is disabled.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// This should ideally be done during creation, using the [`nonblocking` field] of the creation options, unless there&#39;s a good reason not to: this method has O(n) complexity, since it has to iterate through all instances, and it may leave the instances in an inconsistent state where some are nonblocking and some are not if the operation fails for one of them (which will be reported as failure, even though some may have successfully been reconfigured).</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// See the documentation of the aforementioned field for the exact effects of enabling this mode.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// [`nonblocking` field]: struct.PipeListenerOptions.html#structfield.nonblocking &quot; &quot;</span>
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">set_nonblocking</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">nonblocking</span>: <span class="ident">bool</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
        <span class="kw">for</span> <span class="ident">instance</span> <span class="kw">in</span> <span class="self">self</span>
            .<span class="ident">instances</span>
            .<span class="ident">read</span>()
            .<span class="ident">expect</span>(<span class="string">&quot;unexpected lock poison&quot;</span>)
            .<span class="ident">iter</span>()
        {
            <span class="kw">unsafe</span> {
                <span class="ident">set_nonblocking_for_stream</span>::<span class="op">&lt;</span><span class="ident">Stream</span><span class="op">&gt;</span>(<span class="ident">instance</span>.<span class="number">0</span> .<span class="number">0</span> .<span class="number">0</span>, <span class="ident">nonblocking</span>)<span class="question-mark">?</span>;
            }
        }
        <span class="self">self</span>.<span class="ident">nonblocking</span>.<span class="ident">store</span>(<span class="ident">nonblocking</span>, <span class="ident">Ordering::SeqCst</span>);
        <span class="prelude-val">Ok</span>(())
    }

    <span class="doccomment">/// Returns a pipe instance either by using an existing one or returning a newly created instance using `add_instance`.</span>
    <span class="kw">fn</span> <span class="ident">alloc_instance</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="ident">Arc</span><span class="op">&lt;</span>(<span class="ident">PipeOps</span>, <span class="ident">AtomicBool</span>)<span class="op">&gt;</span><span class="op">&gt;</span> {
        <span class="kw">let</span> <span class="ident">instances</span> <span class="op">=</span> <span class="self">self</span>.<span class="ident">instances</span>.<span class="ident">read</span>().<span class="ident">expect</span>(<span class="string">&quot;unexpected lock poison&quot;</span>);
        <span class="kw">for</span> <span class="ident">inst</span> <span class="kw">in</span> <span class="ident">instances</span>.<span class="ident">iter</span>() {
            <span class="comment">// Try to ownership for the instance by doing a combined compare+exchange, just</span>
            <span class="comment">// like a mutex does.</span>
            <span class="kw">let</span> <span class="ident">cmpxchg_result</span> <span class="op">=</span>
                <span class="ident">inst</span>.<span class="number">1</span>
                    .<span class="ident">compare_exchange</span>(<span class="bool-val">false</span>, <span class="bool-val">true</span>, <span class="ident">Ordering::AcqRel</span>, <span class="ident">Ordering::Relaxed</span>);
            <span class="kw">if</span> <span class="ident">cmpxchg_result</span>.<span class="ident">is_ok</span>() {
                <span class="comment">// If the compare+exchange returned Ok, then we successfully took ownership of the</span>
                <span class="comment">// pipe instance and we can return it right away.</span>
                <span class="kw">return</span> <span class="prelude-val">Ok</span>(<span class="ident">Arc::clone</span>(<span class="ident">inst</span>));
            }
            <span class="comment">// If not, the pipe we tried to claim is already at work and we need to seek a new</span>
            <span class="comment">// one, which is what the next iteration will do.</span>
        }
        <span class="comment">// If we searched through the entire thing and never found a free pipe, there isn&#39;t one</span>
        <span class="comment">// available, which is why we need a new one.</span>
        <span class="kw">let</span> <span class="ident">new_inst</span> <span class="op">=</span> <span class="self">self</span>.<span class="ident">add_instance</span>()<span class="question-mark">?</span>;
        <span class="ident">mem::drop</span>(<span class="ident">instances</span>); <span class="comment">// Get rid of the old lock to lock again with write access.</span>
        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">instances</span> <span class="op">=</span> <span class="self">self</span>.<span class="ident">instances</span>.<span class="ident">write</span>().<span class="ident">expect</span>(<span class="string">&quot;unexpected lock poison&quot;</span>);
        <span class="ident">instances</span>.<span class="ident">push</span>(<span class="ident">Arc::clone</span>(<span class="kw-2">&amp;</span><span class="ident">new_inst</span>));
        <span class="prelude-val">Ok</span>(<span class="ident">new_inst</span>)
    }
    <span class="doccomment">/// Increases instance count by 1 and returns the created instance.</span>
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">fn</span> <span class="ident">add_instance</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="ident">Arc</span><span class="op">&lt;</span>(<span class="ident">PipeOps</span>, <span class="ident">AtomicBool</span>)<span class="op">&gt;</span><span class="op">&gt;</span> {
        <span class="kw">let</span> <span class="ident">new_instance</span> <span class="op">=</span> <span class="ident">Arc::new</span>(
            <span class="self">self</span>.<span class="ident">config</span>
                .<span class="ident">create_instance</span>::<span class="op">&lt;</span><span class="ident">Stream</span><span class="op">&gt;</span>(<span class="bool-val">false</span>, <span class="self">self</span>.<span class="ident">nonblocking</span>.<span class="ident">load</span>(<span class="ident">Ordering::SeqCst</span>))<span class="question-mark">?</span>,
        );
        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">instances</span> <span class="op">=</span> <span class="self">self</span>.<span class="ident">instances</span>.<span class="ident">write</span>().<span class="ident">expect</span>(<span class="string">&quot;unexpected lock poison&quot;</span>);
        <span class="ident">instances</span>.<span class="ident">push</span>(<span class="ident">Arc::clone</span>(<span class="kw-2">&amp;</span><span class="ident">new_instance</span>));
        <span class="prelude-val">Ok</span>(<span class="ident">new_instance</span>)
    }
}

<span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">windows</span>)]</span>
<span class="kw">unsafe</span> <span class="kw">fn</span> <span class="ident">set_nonblocking_for_stream</span><span class="op">&lt;</span><span class="ident">Stream</span>: <span class="ident">PipeStream</span><span class="op">&gt;</span>(
    <span class="ident">handle</span>: <span class="ident">HANDLE</span>,
    <span class="ident">nonblocking</span>: <span class="ident">bool</span>,
) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
    <span class="kw">let</span> <span class="ident">read_mode</span>: <span class="ident">u32</span> <span class="op">=</span> <span class="ident">Stream::READ_MODE</span>.<span class="ident">map_or</span>(<span class="number">0</span>, <span class="ident">PipeMode::to_readmode</span>);
    <span class="comment">// Bitcast the boolean without additional transformatinos since</span>
    <span class="comment">// the flag is in the first bit.</span>
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">mode</span>: <span class="ident">u32</span> <span class="op">=</span> <span class="ident">read_mode</span> <span class="op">|</span> <span class="ident">nonblocking</span> <span class="kw">as</span> <span class="ident">u32</span>;
    <span class="kw">let</span> <span class="ident">success</span> <span class="op">=</span> <span class="ident">SetNamedPipeHandleState</span>(
        <span class="ident">handle</span>,
        <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">mode</span> <span class="kw">as</span> <span class="kw-2">*</span><span class="kw-2">mut</span> <span class="kw">_</span>,
        <span class="ident">ptr::null_mut</span>(),
        <span class="ident">ptr::null_mut</span>(),
    ) <span class="op">!</span><span class="op">=</span> <span class="number">0</span>;
    <span class="kw">if</span> <span class="ident">success</span> {
        <span class="prelude-val">Ok</span>(())
    } <span class="kw">else</span> {
        <span class="prelude-val">Err</span>(<span class="ident">io::Error::last_os_error</span>())
    }
}

<span class="kw">mod</span> <span class="ident">pipe_listener_debug_impl</span> {
    <span class="kw">use</span> <span class="kw">super</span>::<span class="kw-2">*</span>;
    <span class="doccomment">/// Shim used to improve pipe instance formatting</span>
    <span class="kw">struct</span> <span class="ident">Instance</span><span class="op">&lt;</span><span class="lifetime">&#39;a</span><span class="op">&gt;</span> {
        <span class="ident">instance</span>: <span class="kw-2">&amp;</span><span class="lifetime">&#39;a</span> (<span class="ident">PipeOps</span>, <span class="ident">AtomicBool</span>),
    }
    <span class="kw">impl</span><span class="op">&lt;</span><span class="lifetime">&#39;a</span><span class="op">&gt;</span> <span class="ident">Debug</span> <span class="kw">for</span> <span class="ident">Instance</span><span class="op">&lt;</span><span class="lifetime">&#39;a</span><span class="op">&gt;</span> {
        <span class="attribute">#[<span class="ident">inline</span>]</span>
        <span class="kw">fn</span> <span class="ident">fmt</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">f</span>: <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">Formatter</span><span class="op">&lt;</span><span class="lifetime">&#39;_</span><span class="op">&gt;</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">fmt::Result</span> {
            <span class="ident">f</span>.<span class="ident">debug_struct</span>(<span class="string">&quot;PipeInstance&quot;</span>)
                .<span class="ident">field</span>(<span class="string">&quot;handle&quot;</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">as_raw_handle</span>())
                .<span class="ident">field</span>(<span class="string">&quot;connected&quot;</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">instance</span>.<span class="number">1</span>.<span class="ident">load</span>(<span class="ident">Ordering::Relaxed</span>))
                .<span class="ident">finish</span>()
        }
    }
    <span class="doccomment">/// Another shim which uses the Instance shim to print each of the instances as a list</span>
    <span class="kw">struct</span> <span class="ident">Instances</span><span class="op">&lt;</span><span class="lifetime">&#39;a</span><span class="op">&gt;</span> {
        <span class="ident">instances</span>: <span class="kw-2">&amp;</span><span class="lifetime">&#39;a</span> <span class="ident">RwLock</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Arc</span><span class="op">&lt;</span>(<span class="ident">PipeOps</span>, <span class="ident">AtomicBool</span>)<span class="op">&gt;</span><span class="op">&gt;</span><span class="op">&gt;</span>,
    }
    <span class="kw">impl</span><span class="op">&lt;</span><span class="lifetime">&#39;a</span><span class="op">&gt;</span> <span class="ident">Debug</span> <span class="kw">for</span> <span class="ident">Instances</span><span class="op">&lt;</span><span class="lifetime">&#39;a</span><span class="op">&gt;</span> {
        <span class="attribute">#[<span class="ident">inline</span>]</span>
        <span class="kw">fn</span> <span class="ident">fmt</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">f</span>: <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">Formatter</span><span class="op">&lt;</span><span class="lifetime">&#39;_</span><span class="op">&gt;</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">fmt::Result</span> {
            <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">list_builder</span> <span class="op">=</span> <span class="ident">f</span>.<span class="ident">debug_list</span>();
            <span class="kw">for</span> <span class="ident">instance</span> <span class="kw">in</span> <span class="self">self</span>
                .<span class="ident">instances</span>
                .<span class="ident">read</span>()
                .<span class="ident">expect</span>(<span class="string">&quot;unexpected lock poisoning&quot;</span>)
                .<span class="ident">iter</span>()
            {
                <span class="ident">list_builder</span>.<span class="ident">entry</span>(<span class="kw-2">&amp;</span><span class="ident">Instance</span> { <span class="ident">instance</span> });
            }
            <span class="ident">list_builder</span>.<span class="ident">finish</span>()
        }
    }
    <span class="kw">impl</span><span class="op">&lt;</span><span class="ident">Stream</span>: <span class="ident">PipeStream</span><span class="op">&gt;</span> <span class="ident">Debug</span> <span class="kw">for</span> <span class="ident">PipeListener</span><span class="op">&lt;</span><span class="ident">Stream</span><span class="op">&gt;</span> {
        <span class="attribute">#[<span class="ident">inline</span>]</span>
        <span class="kw">fn</span> <span class="ident">fmt</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">f</span>: <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">Formatter</span><span class="op">&lt;</span><span class="lifetime">&#39;_</span><span class="op">&gt;</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">fmt::Result</span> {
            <span class="ident">f</span>.<span class="ident">debug_struct</span>(<span class="string">&quot;PipeListener&quot;</span>)
                .<span class="ident">field</span>(<span class="string">&quot;config&quot;</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">config</span>)
                .<span class="ident">field</span>(
                    <span class="string">&quot;instances&quot;</span>,
                    <span class="kw-2">&amp;</span><span class="ident">Instances</span> {
                        <span class="ident">instances</span>: <span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">instances</span>,
                    },
                )
                .<span class="ident">finish</span>()
        }
    }
}

<span class="kw">use</span> <span class="ident">seal</span>::<span class="kw-2">*</span>;
<span class="kw">mod</span> <span class="ident">seal</span> {
    <span class="kw">use</span> <span class="ident"><span class="kw">super</span>::<span class="kw">super</span>::FileHandleOps</span>;
    <span class="kw">use</span> <span class="kw">super</span>::<span class="kw-2">*</span>;

    <span class="kw">pub</span> <span class="kw">trait</span> <span class="ident">NamedPipeStreamInternals</span>: <span class="ident">From</span><span class="op">&lt;</span><span class="ident">Arc</span><span class="op">&lt;</span>(<span class="ident">PipeOps</span>, <span class="ident">AtomicBool</span>)<span class="op">&gt;</span><span class="op">&gt;</span> {}

    <span class="doccomment">/// The actual implementation of a named pipe server or client.</span>
    <span class="attribute">#[<span class="ident">repr</span>(<span class="ident">transparent</span>)]</span>
    <span class="kw">pub</span> <span class="kw">struct</span> <span class="ident">PipeOps</span>(<span class="kw">pub</span>(<span class="kw">super</span>) <span class="ident">FileHandleOps</span>);
    <span class="kw">impl</span> <span class="ident">PipeOps</span> {
        <span class="doccomment">/// Reads a message from the pipe instance into the specified buffer, returning the size of the message written as `Ok(Ok(...))`. If the buffer is too small to fit the message, a bigger buffer is allocated and returned as `Ok(Err(...))`, with the exact size and capacity to hold the message. Errors are returned as `Err(Err(...))`.</span>
        <span class="attribute">#[<span class="ident">inline</span>]</span>
        <span class="kw">pub</span>(<span class="kw">super</span>) <span class="kw">fn</span> <span class="ident">read_msg</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">buf</span>: <span class="kw-2">&amp;</span><span class="kw-2">mut</span> [<span class="ident">u8</span>]) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">usize</span>, <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u8</span><span class="op">&gt;</span><span class="op">&gt;</span><span class="op">&gt;</span> {
            <span class="kw">match</span> <span class="self">self</span>.<span class="ident">try_read_msg</span>(<span class="ident">buf</span>)<span class="question-mark">?</span> {
                <span class="prelude-val">Ok</span>(<span class="ident">bytes_read</span>) <span class="op">=</span><span class="op">&gt;</span> <span class="prelude-val">Ok</span>(<span class="prelude-val">Ok</span>(<span class="ident">bytes_read</span>)),
                <span class="prelude-val">Err</span>(<span class="ident">bytes_left_in_message</span>) <span class="op">=</span><span class="op">&gt;</span> {
                    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">new_buffer</span> <span class="op">=</span> <span class="macro">vec!</span>[<span class="number">0</span>; <span class="ident">bytes_left_in_message</span>];
                    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">_number_of_bytes_read</span>: <span class="ident">DWORD</span> <span class="op">=</span> <span class="number">0</span>;
                    <span class="kw">let</span> <span class="ident">success</span> <span class="op">=</span> <span class="kw">unsafe</span> {
                        <span class="ident">ReadFile</span>(
                            <span class="self">self</span>.<span class="ident">as_raw_handle</span>(),
                            <span class="ident">new_buffer</span>.<span class="ident">as_mut_slice</span>().<span class="ident">as_mut_ptr</span>() <span class="kw">as</span> <span class="kw-2">*</span><span class="kw-2">mut</span> <span class="kw">_</span>,
                            <span class="ident">buf</span>.<span class="ident">len</span>() <span class="kw">as</span> <span class="ident">DWORD</span>,
                            <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">_number_of_bytes_read</span> <span class="kw">as</span> <span class="kw-2">*</span><span class="kw-2">mut</span> <span class="kw">_</span>,
                            <span class="ident">ptr::null_mut</span>(),
                        ) <span class="op">!</span><span class="op">=</span> <span class="number">0</span>
                    };
                    <span class="kw">if</span> <span class="ident">success</span> {
                        <span class="prelude-val">Ok</span>(<span class="prelude-val">Err</span>(<span class="ident">new_buffer</span>))
                    } <span class="kw">else</span> {
                        <span class="prelude-val">Err</span>(<span class="ident">io::Error::last_os_error</span>())
                    }
                }
            }
        }
        <span class="kw">pub</span>(<span class="kw">super</span>) <span class="kw">fn</span> <span class="ident">try_read_msg</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">buf</span>: <span class="kw-2">&amp;</span><span class="kw-2">mut</span> [<span class="ident">u8</span>]) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">usize</span>, <span class="ident">usize</span><span class="op">&gt;</span><span class="op">&gt;</span> {
            <span class="macro">debug_assert!</span>(
                <span class="ident">buf</span>.<span class="ident">len</span>() <span class="op">&lt;</span><span class="op">=</span> <span class="ident">DWORD::max_value</span>() <span class="kw">as</span> <span class="ident">usize</span>,
                <span class="string">&quot;buffer is bigger than maximum buffer size for ReadFile&quot;</span>,
            );
            <span class="kw">let</span> <span class="ident">bytes_left_in_message</span> <span class="op">=</span> <span class="kw">unsafe</span> {
                <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">bytes_left_in_message</span>: <span class="ident">DWORD</span> <span class="op">=</span> <span class="number">0</span>;
                <span class="kw">let</span> <span class="ident">result</span> <span class="op">=</span> <span class="ident">PeekNamedPipe</span>(
                    <span class="self">self</span>.<span class="ident">as_raw_handle</span>(),
                    <span class="ident">ptr::null_mut</span>(),
                    <span class="number">0</span>,
                    <span class="ident">ptr::null_mut</span>(),
                    <span class="ident">ptr::null_mut</span>(),
                    <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">bytes_left_in_message</span> <span class="kw">as</span> <span class="kw-2">*</span><span class="kw-2">mut</span> <span class="kw">_</span>,
                );
                <span class="kw">if</span> <span class="ident">result</span> <span class="op">=</span><span class="op">=</span> <span class="number">0</span> {
                    <span class="kw">return</span> <span class="prelude-val">Err</span>(<span class="ident">io::Error::last_os_error</span>());
                }
                <span class="ident">bytes_left_in_message</span> <span class="kw">as</span> <span class="ident">usize</span>
            };
            <span class="kw">if</span> <span class="ident">buf</span>.<span class="ident">len</span>() <span class="op">&gt;</span><span class="op">=</span> <span class="ident">bytes_left_in_message</span> {
                <span class="comment">// We already know the exact size of the message which is why this does not matter</span>
                <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">_number_of_bytes_read</span>: <span class="ident">DWORD</span> <span class="op">=</span> <span class="number">0</span>;
                <span class="kw">let</span> <span class="ident">success</span> <span class="op">=</span> <span class="kw">unsafe</span> {
                    <span class="ident">ReadFile</span>(
                        <span class="self">self</span>.<span class="ident">as_raw_handle</span>(),
                        <span class="ident">buf</span>.<span class="ident">as_mut_ptr</span>() <span class="kw">as</span> <span class="kw-2">*</span><span class="kw-2">mut</span> <span class="kw">_</span>,
                        <span class="ident">buf</span>.<span class="ident">len</span>() <span class="kw">as</span> <span class="ident">DWORD</span>,
                        <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">_number_of_bytes_read</span> <span class="kw">as</span> <span class="kw-2">*</span><span class="kw-2">mut</span> <span class="kw">_</span>,
                        <span class="ident">ptr::null_mut</span>(),
                    ) <span class="op">!</span><span class="op">=</span> <span class="number">0</span>
                };
                <span class="kw">if</span> <span class="ident">success</span> {
                    <span class="prelude-val">Ok</span>(<span class="prelude-val">Ok</span>(<span class="ident">bytes_left_in_message</span>))
                } <span class="kw">else</span> {
                    <span class="prelude-val">Err</span>(<span class="ident">io::Error::last_os_error</span>())
                }
            } <span class="kw">else</span> {
                <span class="prelude-val">Ok</span>(<span class="prelude-val">Err</span>(<span class="ident">bytes_left_in_message</span>))
            }
        }
        <span class="doccomment">/// Reads bytes from the named pipe. Mirrors `std::io::Read`.</span>
        <span class="attribute">#[<span class="ident">inline</span>]</span>
        <span class="kw">pub</span>(<span class="kw">super</span>) <span class="kw">fn</span> <span class="ident">read_bytes</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">buf</span>: <span class="kw-2">&amp;</span><span class="kw-2">mut</span> [<span class="ident">u8</span>]) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="ident">usize</span><span class="op">&gt;</span> {
            <span class="self">self</span>.<span class="number">0</span>.<span class="ident">read</span>(<span class="ident">buf</span>)
        }
        <span class="doccomment">/// Writes data to the named pipe. There is no way to check/ensure that the message boundaries will be preserved which is why there&#39;s only one function to do this.</span>
        <span class="attribute">#[<span class="ident">inline</span>]</span>
        <span class="kw">pub</span>(<span class="kw">super</span>) <span class="kw">fn</span> <span class="ident">write</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">buf</span>: <span class="kw-2">&amp;</span>[<span class="ident">u8</span>]) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="ident">usize</span><span class="op">&gt;</span> {
            <span class="self">self</span>.<span class="number">0</span>.<span class="ident">write</span>(<span class="ident">buf</span>)
        }
        <span class="doccomment">/// Blocks until the client has fully read the buffer.</span>
        <span class="attribute">#[<span class="ident">inline</span>]</span>
        <span class="kw">pub</span>(<span class="kw">super</span>) <span class="kw">fn</span> <span class="ident">flush</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
            <span class="self">self</span>.<span class="number">0</span>.<span class="ident">flush</span>()
        }

        <span class="attribute">#[<span class="ident">inline</span>]</span>
        <span class="kw">pub</span>(<span class="kw">super</span>) <span class="kw">fn</span> <span class="ident">get_client_process_id</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="ident">u32</span><span class="op">&gt;</span> {
            <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">id</span>: <span class="ident">u32</span> <span class="op">=</span> <span class="number">0</span>;
            <span class="kw">let</span> <span class="ident">success</span> <span class="op">=</span> <span class="kw">unsafe</span> { <span class="ident">GetNamedPipeClientProcessId</span>(<span class="self">self</span>.<span class="number">0</span> .<span class="number">0</span>, <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">id</span> <span class="kw">as</span> <span class="kw-2">*</span><span class="kw-2">mut</span> <span class="kw">_</span>) <span class="op">!</span><span class="op">=</span> <span class="number">0</span> };
            <span class="kw">if</span> <span class="ident">success</span> {
                <span class="prelude-val">Ok</span>(<span class="ident">id</span>)
            } <span class="kw">else</span> {
                <span class="prelude-val">Err</span>(<span class="ident">io::Error::last_os_error</span>())
            }
        }
        <span class="attribute">#[<span class="ident">inline</span>]</span>
        <span class="kw">pub</span>(<span class="kw">super</span>) <span class="kw">fn</span> <span class="ident">get_client_session_id</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="ident">u32</span><span class="op">&gt;</span> {
            <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">id</span>: <span class="ident">u32</span> <span class="op">=</span> <span class="number">0</span>;
            <span class="kw">let</span> <span class="ident">success</span> <span class="op">=</span> <span class="kw">unsafe</span> { <span class="ident">GetNamedPipeClientSessionId</span>(<span class="self">self</span>.<span class="number">0</span> .<span class="number">0</span>, <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">id</span> <span class="kw">as</span> <span class="kw-2">*</span><span class="kw-2">mut</span> <span class="kw">_</span>) <span class="op">!</span><span class="op">=</span> <span class="number">0</span> };
            <span class="kw">if</span> <span class="ident">success</span> {
                <span class="prelude-val">Ok</span>(<span class="ident">id</span>)
            } <span class="kw">else</span> {
                <span class="prelude-val">Err</span>(<span class="ident">io::Error::last_os_error</span>())
            }
        }
        <span class="attribute">#[<span class="ident">inline</span>]</span>
        <span class="kw">pub</span>(<span class="kw">super</span>) <span class="kw">fn</span> <span class="ident">get_server_process_id</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="ident">u32</span><span class="op">&gt;</span> {
            <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">id</span>: <span class="ident">u32</span> <span class="op">=</span> <span class="number">0</span>;
            <span class="kw">let</span> <span class="ident">success</span> <span class="op">=</span> <span class="kw">unsafe</span> { <span class="ident">GetNamedPipeServerProcessId</span>(<span class="self">self</span>.<span class="number">0</span> .<span class="number">0</span>, <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">id</span> <span class="kw">as</span> <span class="kw-2">*</span><span class="kw-2">mut</span> <span class="kw">_</span>) <span class="op">!</span><span class="op">=</span> <span class="number">0</span> };
            <span class="kw">if</span> <span class="ident">success</span> {
                <span class="prelude-val">Ok</span>(<span class="ident">id</span>)
            } <span class="kw">else</span> {
                <span class="prelude-val">Err</span>(<span class="ident">io::Error::last_os_error</span>())
            }
        }
        <span class="attribute">#[<span class="ident">inline</span>]</span>
        <span class="kw">pub</span>(<span class="kw">super</span>) <span class="kw">fn</span> <span class="ident">get_server_session_id</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="ident">u32</span><span class="op">&gt;</span> {
            <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">id</span>: <span class="ident">u32</span> <span class="op">=</span> <span class="number">0</span>;
            <span class="kw">let</span> <span class="ident">success</span> <span class="op">=</span> <span class="kw">unsafe</span> { <span class="ident">GetNamedPipeServerSessionId</span>(<span class="self">self</span>.<span class="number">0</span> .<span class="number">0</span>, <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">id</span> <span class="kw">as</span> <span class="kw-2">*</span><span class="kw-2">mut</span> <span class="kw">_</span>) <span class="op">!</span><span class="op">=</span> <span class="number">0</span> };
            <span class="kw">if</span> <span class="ident">success</span> {
                <span class="prelude-val">Ok</span>(<span class="ident">id</span>)
            } <span class="kw">else</span> {
                <span class="prelude-val">Err</span>(<span class="ident">io::Error::last_os_error</span>())
            }
        }

        <span class="doccomment">/// Blocks until connected. If connected, does not do anything.</span>
        <span class="kw">pub</span>(<span class="kw">super</span>) <span class="kw">fn</span> <span class="ident">connect</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
            <span class="kw">let</span> <span class="ident">success</span> <span class="op">=</span> <span class="kw">unsafe</span> { <span class="ident">ConnectNamedPipe</span>(<span class="self">self</span>.<span class="ident">as_raw_handle</span>(), <span class="ident">ptr::null_mut</span>()) <span class="op">!</span><span class="op">=</span> <span class="number">0</span> };
            <span class="kw">if</span> <span class="ident">success</span> {
                <span class="prelude-val">Ok</span>(())
            } <span class="kw">else</span> {
                <span class="kw">let</span> <span class="ident">last_error</span> <span class="op">=</span> <span class="ident">io::Error::last_os_error</span>();
                <span class="kw">if</span> <span class="ident">last_error</span>.<span class="ident">raw_os_error</span>() <span class="op">=</span><span class="op">=</span> <span class="prelude-val">Some</span>(<span class="ident">ERROR_PIPE_CONNECTED</span> <span class="kw">as</span> <span class="ident">i32</span>) {
                    <span class="prelude-val">Ok</span>(())
                } <span class="kw">else</span> {
                    <span class="prelude-val">Err</span>(<span class="ident">last_error</span>)
                }
            }
        }
        <span class="doccomment">/// Flushes and disconnects, obviously.</span>
        <span class="attribute">#[<span class="ident">inline</span>]</span>
        <span class="kw">pub</span>(<span class="kw">super</span>) <span class="kw">fn</span> <span class="ident">flush_and_disconnect</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
            <span class="self">self</span>.<span class="ident">flush</span>()<span class="question-mark">?</span>;
            <span class="self">self</span>.<span class="ident">disconnect</span>()<span class="question-mark">?</span>;
            <span class="prelude-val">Ok</span>(())
        }
        <span class="doccomment">/// Disconnects without flushing. Drops all data which has been sent but not yet received on the other side, if any.</span>
        <span class="attribute">#[<span class="ident">inline</span>]</span>
        <span class="kw">pub</span>(<span class="kw">super</span>) <span class="kw">fn</span> <span class="ident">disconnect</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
            <span class="kw">let</span> <span class="ident">success</span> <span class="op">=</span> <span class="kw">unsafe</span> { <span class="ident">DisconnectNamedPipe</span>(<span class="self">self</span>.<span class="ident">as_raw_handle</span>()) <span class="op">!</span><span class="op">=</span> <span class="number">0</span> };
            <span class="kw">if</span> <span class="ident">success</span> {
                <span class="prelude-val">Ok</span>(())
            } <span class="kw">else</span> {
                <span class="prelude-val">Err</span>(<span class="ident">io::Error::last_os_error</span>())
            }
        }
    }
    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">windows</span>)]</span>
    <span class="kw">impl</span> <span class="ident">AsRawHandle</span> <span class="kw">for</span> <span class="ident">PipeOps</span> {
        <span class="attribute">#[<span class="ident">inline</span>]</span>
        <span class="kw">fn</span> <span class="ident">as_raw_handle</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">HANDLE</span> {
            <span class="self">self</span>.<span class="number">0</span> .<span class="number">0</span> <span class="comment">// I hate this nested tuple syntax.</span>
        }
    }
    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">windows</span>)]</span>
    <span class="kw">impl</span> <span class="ident">IntoRawHandle</span> <span class="kw">for</span> <span class="ident">PipeOps</span> {
        <span class="attribute">#[<span class="ident">inline</span>]</span>
        <span class="kw">fn</span> <span class="ident">into_raw_handle</span>(<span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">HANDLE</span> {
            <span class="kw">let</span> <span class="ident">handle</span> <span class="op">=</span> <span class="self">self</span>.<span class="ident">as_raw_handle</span>();
            <span class="ident">std::mem::forget</span>(<span class="self">self</span>);
            <span class="ident">handle</span>
        }
    }
    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">windows</span>)]</span>
    <span class="kw">impl</span> <span class="ident">FromRawHandle</span> <span class="kw">for</span> <span class="ident">PipeOps</span> {
        <span class="kw">unsafe</span> <span class="kw">fn</span> <span class="ident">from_raw_handle</span>(<span class="ident">handle</span>: <span class="ident">HANDLE</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="self">Self</span> {
            <span class="self">Self</span>(<span class="ident">FileHandleOps::from_raw_handle</span>(<span class="ident">handle</span>))
        }
    }
    <span class="comment">// SAFETY: we don&#39;t expose reading/writing for immutable references of PipeInstance</span>
    <span class="kw">unsafe</span> <span class="kw">impl</span> <span class="ident">Sync</span> <span class="kw">for</span> <span class="ident">PipeOps</span> {}
    <span class="kw">unsafe</span> <span class="kw">impl</span> <span class="ident">Send</span> <span class="kw">for</span> <span class="ident">PipeOps</span> {}
}
<span class="doccomment">/// Allows for thorough customization of [`PipeListener`]s during creation.</span>
<span class="doccomment">///</span>
<span class="doccomment">/// [`PipeListener`]: struct.PipeListener.html &quot; &quot;</span>
<span class="attribute">#[<span class="ident">derive</span>(<span class="ident">Clone</span>, <span class="ident">Debug</span>, <span class="ident">PartialEq</span>, <span class="ident">Eq</span>, <span class="ident">Hash</span>)]</span>
<span class="attribute">#[<span class="ident">non_exhaustive</span>]</span>
<span class="kw">pub</span> <span class="kw">struct</span> <span class="ident">PipeListenerOptions</span><span class="op">&lt;</span><span class="lifetime">&#39;a</span><span class="op">&gt;</span> {
    <span class="doccomment">/// Specifies the name for the named pipe. Since the name typically, but not always, is a string literal, an owned string does not need to be provided.</span>
    <span class="kw">pub</span> <span class="ident">name</span>: <span class="ident">Cow</span><span class="op">&lt;</span><span class="lifetime">&#39;a</span>, <span class="ident">OsStr</span><span class="op">&gt;</span>,
    <span class="doccomment">/// Specifies how data is written into the data stream. This is required in all cases, regardless of whether the pipe is inbound, outbound or duplex, since this affects all data being written into the pipe, not just the data written by the server.</span>
    <span class="kw">pub</span> <span class="ident">mode</span>: <span class="ident">PipeMode</span>,
    <span class="doccomment">/// Specifies whether nonblocking mode will be enabled for all stream instances upon creation. By default, it is disabled.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// There are two ways in which the listener is affected by nonblocking mode:</span>
    <span class="doccomment">/// - Whenever [`accept`] is called or [`incoming`] is being iterated through, if there is no client currently attempting to connect to the named pipe server, the method will return immediately with the [`WouldBlock`] error instead of blocking until one arrives.</span>
    <span class="doccomment">/// - The streams created by [`accept`] and [`incoming`] behave similarly to how client-side streams behave in nonblocking mode. See the documentation for `set_nonblocking` for an explanation of the exact effects.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// [`accept`]: struct.PipeListener.html#method.accept &quot; &quot;</span>
    <span class="doccomment">/// [`incoming`]: struct.PipeListener.html#method.incoming &quot; &quot;</span>
    <span class="doccomment">/// [`WouldBlock`]: https://doc.rust-lang.org/std/io/enum.ErrorKind.html#variant.WouldBlock &quot; &quot;</span>
    <span class="kw">pub</span> <span class="ident">nonblocking</span>: <span class="ident">bool</span>,
    <span class="doccomment">/// Specifies the maximum amount of instances of the pipe which can be created, i.e. how many clients can be communicated with at once. If set to 1, trying to create multiple instances at the same time will return an error. If set to `None`, no limit is applied. The value 255 is not allowed because of Windows limitations.</span>
    <span class="kw">pub</span> <span class="ident">instance_limit</span>: <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">NonZeroU8</span><span class="op">&gt;</span>,
    <span class="doccomment">/// Enables write-through mode, which applies only to network connections to the pipe. If enabled, writing to the pipe would always block until all data is delivered to the other end instead of piling up in the kernel&#39;s network buffer until a certain amount of data accamulates or a certain period of time passes, which is when the system actually sends the contents of the buffer over the network.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// Not required for pipes which are restricted to local connections only. If debug assertions are enabled, setting this parameter on a local-only pipe will cause a panic when the pipe is created; in release builds, creation will successfully complete without any errors and the flag will be completely ignored.</span>
    <span class="kw">pub</span> <span class="ident">write_through</span>: <span class="ident">bool</span>,
    <span class="doccomment">/// Enables remote machines to connect to the named pipe over the network.</span>
    <span class="kw">pub</span> <span class="ident">accept_remote</span>: <span class="ident">bool</span>,
    <span class="doccomment">/// Specifies how big the input buffer should be. The system will automatically adjust this size to align it as required or clip it by the minimum or maximum buffer size.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// Not required for outbound pipes and required for inbound and duplex pipes. If debug assertions are enabled, setting this parameter on an outbound pipe will cause a panic when the pipe is created; in release builds, creation will successfully complete without any errors and the value will be completely ignored.</span>
    <span class="kw">pub</span> <span class="ident">input_buffer_size_hint</span>: <span class="ident">usize</span>,
    <span class="doccomment">/// Specifies how big the output buffer should be. The system will automatically adjust this size to align it as required or clip it by the minimum or maximum buffer size.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// Not required for inbound pipes and required for outbound and duplex pipes. If debug assertions are enabled, setting this parameter on an inbound pipe will cause a panic when the pipe is created; in release builds, creation will successfully complete without any errors and the value will be completely ignored.</span>
    <span class="kw">pub</span> <span class="ident">output_buffer_size_hint</span>: <span class="ident">usize</span>,
    <span class="doccomment">/// The default timeout when waiting for a client to connect. Used unless another timeout is specified when waiting for a client.</span>
    <span class="kw">pub</span> <span class="ident">wait_timeout</span>: <span class="ident">NonZeroU32</span>,
}
<span class="kw">impl</span><span class="op">&lt;</span><span class="lifetime">&#39;a</span><span class="op">&gt;</span> <span class="ident">PipeListenerOptions</span><span class="op">&lt;</span><span class="lifetime">&#39;a</span><span class="op">&gt;</span> {
    <span class="doccomment">/// Creates a new builder with default options.</span>
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">new</span>() <span class="op">-</span><span class="op">&gt;</span> <span class="self">Self</span> {
        <span class="self">Self</span> {
            <span class="ident">name</span>: <span class="ident">Cow::Borrowed</span>(<span class="ident">OsStr::new</span>(<span class="string">&quot;&quot;</span>)),
            <span class="ident">mode</span>: <span class="ident">PipeMode::Bytes</span>,
            <span class="ident">nonblocking</span>: <span class="bool-val">false</span>,
            <span class="ident">instance_limit</span>: <span class="prelude-val">None</span>,
            <span class="ident">write_through</span>: <span class="bool-val">false</span>,
            <span class="ident">accept_remote</span>: <span class="bool-val">false</span>,
            <span class="ident">input_buffer_size_hint</span>: <span class="number">512</span>,
            <span class="ident">output_buffer_size_hint</span>: <span class="number">512</span>,
            <span class="ident">wait_timeout</span>: <span class="kw">unsafe</span> { <span class="ident">NonZeroU32::new_unchecked</span>(<span class="number">50</span>) },
        }
    }
    <span class="doccomment">/// Sets the [`name`] parameter to the specified value.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// [`name`]: #structfield.name &quot; &quot;</span>
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="attribute">#[<span class="ident">must_use</span> <span class="op">=</span> <span class="string">&quot;builder setters take the entire structure and return the result&quot;</span>]</span>
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">name</span>(<span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">name</span>: <span class="kw">impl</span> <span class="ident">Into</span><span class="op">&lt;</span><span class="ident">Cow</span><span class="op">&lt;</span><span class="lifetime">&#39;a</span>, <span class="ident">OsStr</span><span class="op">&gt;</span><span class="op">&gt;</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="self">Self</span> {
        <span class="self">self</span>.<span class="ident">name</span> <span class="op">=</span> <span class="ident">name</span>.<span class="ident">into</span>();
        <span class="self">self</span>
    }
    <span class="doccomment">/// Sets the [`mode`] parameter to the specified value.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// [`mode`]: #structfield.mode &quot; &quot;</span>
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="attribute">#[<span class="ident">must_use</span> <span class="op">=</span> <span class="string">&quot;builder setters take the entire structure and return the result&quot;</span>]</span>
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">mode</span>(<span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">mode</span>: <span class="ident">PipeMode</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="self">Self</span> {
        <span class="self">self</span>.<span class="ident">mode</span> <span class="op">=</span> <span class="ident">mode</span>;
        <span class="self">self</span>
    }
    <span class="doccomment">/// Sets the [`nonblocking`] parameter to the specified value.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// [`nonblocking`]: #structfield.nonblocking &quot; &quot;</span>
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="attribute">#[<span class="ident">must_use</span> <span class="op">=</span> <span class="string">&quot;builder setters take the entire structure and return the result&quot;</span>]</span>
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">nonblocking</span>(<span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">nonblocking</span>: <span class="ident">bool</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="self">Self</span> {
        <span class="self">self</span>.<span class="ident">nonblocking</span> <span class="op">=</span> <span class="ident">nonblocking</span>;
        <span class="self">self</span>
    }
    <span class="doccomment">/// Sets the [`instance_limit`] parameter to the specified value.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// [`instance_limit`]: #structfield.instance_limit &quot; &quot;</span>
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="attribute">#[<span class="ident">must_use</span> <span class="op">=</span> <span class="string">&quot;builder setters take the entire structure and return the result&quot;</span>]</span>
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">instance_limit</span>(<span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">instance_limit</span>: <span class="kw">impl</span> <span class="ident">Into</span><span class="op">&lt;</span><span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">NonZeroU8</span><span class="op">&gt;</span><span class="op">&gt;</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="self">Self</span> {
        <span class="self">self</span>.<span class="ident">instance_limit</span> <span class="op">=</span> <span class="ident">instance_limit</span>.<span class="ident">into</span>();
        <span class="self">self</span>
    }
    <span class="doccomment">/// Sets the [`write_through`] parameter to the specified value.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// [`write_through`]: #structfield.write_through &quot; &quot;</span>
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="attribute">#[<span class="ident">must_use</span> <span class="op">=</span> <span class="string">&quot;builder setters take the entire structure and return the result&quot;</span>]</span>
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">write_through</span>(<span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">write_through</span>: <span class="ident">bool</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="self">Self</span> {
        <span class="self">self</span>.<span class="ident">write_through</span> <span class="op">=</span> <span class="ident">write_through</span>;
        <span class="self">self</span>
    }
    <span class="doccomment">/// Sets the [`accept_remote`] parameter to the specified value.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// [`accept_remote`]: #structfield.accept_remote &quot; &quot;</span>
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="attribute">#[<span class="ident">must_use</span> <span class="op">=</span> <span class="string">&quot;builder setters take the entire structure and return the result&quot;</span>]</span>
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">accept_remote</span>(<span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">accept_remote</span>: <span class="ident">bool</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="self">Self</span> {
        <span class="self">self</span>.<span class="ident">accept_remote</span> <span class="op">=</span> <span class="ident">accept_remote</span>;
        <span class="self">self</span>
    }
    <span class="doccomment">/// Sets the [`input_buffer_size_hint`] parameter to the specified value.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// [`input_buffer_size_hint`]: #structfield.input_buffer_size_hint &quot; &quot;</span>
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="attribute">#[<span class="ident">must_use</span> <span class="op">=</span> <span class="string">&quot;builder setters take the entire structure and return the result&quot;</span>]</span>
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">input_buffer_size_hint</span>(<span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">input_buffer_size_hint</span>: <span class="kw">impl</span> <span class="ident">Into</span><span class="op">&lt;</span><span class="ident">usize</span><span class="op">&gt;</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="self">Self</span> {
        <span class="self">self</span>.<span class="ident">input_buffer_size_hint</span> <span class="op">=</span> <span class="ident">input_buffer_size_hint</span>.<span class="ident">into</span>();
        <span class="self">self</span>
    }
    <span class="doccomment">/// Sets the [`output_buffer_size_hint`] parameter to the specified value.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// [`output_buffer_size_hint`]: #structfield.output_buffer_size_hint &quot; &quot;</span>
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="attribute">#[<span class="ident">must_use</span> <span class="op">=</span> <span class="string">&quot;builder setters take the entire structure and return the result&quot;</span>]</span>
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">output_buffer_size_hint</span>(<span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">output_buffer_size_hint</span>: <span class="kw">impl</span> <span class="ident">Into</span><span class="op">&lt;</span><span class="ident">usize</span><span class="op">&gt;</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="self">Self</span> {
        <span class="self">self</span>.<span class="ident">output_buffer_size_hint</span> <span class="op">=</span> <span class="ident">output_buffer_size_hint</span>.<span class="ident">into</span>();
        <span class="self">self</span>
    }
    <span class="doccomment">/// Sets the [`wait_timeout`] parameter to the specified value.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// [`wait_timeout`]: #structfield.wait_timeout &quot; &quot;</span>
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="attribute">#[<span class="ident">must_use</span> <span class="op">=</span> <span class="string">&quot;builder setters take the entire structure and return the result&quot;</span>]</span>
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">wait_timeout</span>(<span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">wait_timeout</span>: <span class="kw">impl</span> <span class="ident">Into</span><span class="op">&lt;</span><span class="ident">NonZeroU32</span><span class="op">&gt;</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="self">Self</span> {
        <span class="self">self</span>.<span class="ident">wait_timeout</span> <span class="op">=</span> <span class="ident">wait_timeout</span>.<span class="ident">into</span>();
        <span class="self">self</span>
    }
    <span class="doccomment">/// Creates an instance of a pipe for a listener with the specified stream type and with the first-instance flag set to the specified value.</span>
    <span class="kw">fn</span> <span class="ident">create_instance</span><span class="op">&lt;</span><span class="ident">Stream</span>: <span class="ident">PipeStream</span><span class="op">&gt;</span>(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        <span class="ident">first</span>: <span class="ident">bool</span>,
        <span class="ident">nonblocking</span>: <span class="ident">bool</span>,
    ) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span>(<span class="ident">PipeOps</span>, <span class="ident">AtomicBool</span>)<span class="op">&gt;</span> {
        <span class="kw">let</span> <span class="ident">path</span> <span class="op">=</span> <span class="ident">convert_path</span>(<span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">name</span>);
        <span class="kw">let</span> (<span class="ident">handle</span>, <span class="ident">success</span>) <span class="op">=</span> <span class="kw">unsafe</span> {
            <span class="kw">let</span> <span class="ident">handle</span> <span class="op">=</span> <span class="ident">CreateNamedPipeW</span>(
                <span class="ident">path</span>.<span class="ident">as_ptr</span>(),
                {
                    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">flags</span> <span class="op">=</span> <span class="ident">DWORD::from</span>(<span class="ident">Stream::ROLE</span>.<span class="ident">direction_as_server</span>());
                    <span class="kw">if</span> <span class="ident">first</span> {
                        <span class="ident">flags</span> <span class="op">|</span><span class="op">=</span> <span class="ident">FILE_FLAG_FIRST_PIPE_INSTANCE</span>;
                    }
                    <span class="ident">flags</span>
                },
                <span class="self">self</span>.<span class="ident">mode</span>.<span class="ident">to_pipe_type</span>()
                    <span class="op">|</span> <span class="ident">Stream::READ_MODE</span>.<span class="ident">map_or</span>(<span class="number">0</span>, <span class="op">|</span><span class="ident">x</span><span class="op">|</span> <span class="ident">x</span>.<span class="ident">to_readmode</span>())
                    <span class="op">|</span> <span class="ident">nonblocking</span> <span class="kw">as</span> <span class="ident">u32</span>,
                <span class="self">self</span>.<span class="ident">instance_limit</span>.<span class="ident">map_or</span>(<span class="number">255</span>, <span class="op">|</span><span class="ident">x</span><span class="op">|</span> {
                    <span class="macro">assert!</span>(<span class="ident">x</span>.<span class="ident">get</span>() <span class="op">!</span><span class="op">=</span> <span class="number">255</span>, <span class="string">&quot;cannot set 255 as the named pipe instance limit due to 255 being a reserved value&quot;</span>);
                    <span class="ident">x</span>.<span class="ident">get</span>() <span class="kw">as</span> <span class="ident">DWORD</span>
                }),
                <span class="self">self</span>.<span class="ident">output_buffer_size_hint</span>.<span class="ident">try_into</span>()
                    .<span class="ident">expect</span>(<span class="string">&quot;output buffer size hint overflowed DWORD&quot;</span>),
                <span class="self">self</span>.<span class="ident">input_buffer_size_hint</span>.<span class="ident">try_into</span>()
                    .<span class="ident">expect</span>(<span class="string">&quot;input buffer size hint overflowed DWORD&quot;</span>),
                <span class="self">self</span>.<span class="ident">wait_timeout</span>.<span class="ident">get</span>(),
                <span class="ident">ptr::null_mut</span>(),
            );
            (<span class="ident">handle</span>, <span class="ident">handle</span> <span class="op">!</span><span class="op">=</span> <span class="ident">INVALID_HANDLE_VALUE</span>)
        };
        <span class="kw">if</span> <span class="ident">success</span> {
            <span class="comment">// SAFETY: we just created this handle</span>
            <span class="prelude-val">Ok</span>((
                <span class="kw">unsafe</span> { <span class="ident">PipeOps::from_raw_handle</span>(<span class="ident">handle</span>) },
                <span class="ident">AtomicBool::new</span>(<span class="bool-val">false</span>),
            ))
        } <span class="kw">else</span> {
            <span class="prelude-val">Err</span>(<span class="ident">io::Error::last_os_error</span>())
        }
    }
    <span class="doccomment">/// Creates the pipe listener from the builder. The `Stream` generic argument specifies the type of pipe stream that the listener will create, thus determining the direction of the pipe and its mode.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// For outbound or duplex pipes, the `mode` parameter must agree with the `Stream`&#39;s `WRITE_MODE`. Otherwise, the call will panic in debug builds or, in release builds, the `WRITE_MODE` will take priority.</span>
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">create</span><span class="op">&lt;</span><span class="ident">Stream</span>: <span class="ident">PipeStream</span><span class="op">&gt;</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="ident">PipeListener</span><span class="op">&lt;</span><span class="ident">Stream</span><span class="op">&gt;</span><span class="op">&gt;</span> {
        <span class="comment">// We need this ugliness because the compiler does not understand that</span>
        <span class="comment">// PipeListenerOptions&lt;&#39;a&gt; can coerce into PipeListenerOptions&lt;&#39;static&gt; if we manually</span>
        <span class="comment">// replace the name field with Cow::Owned and just copy all other elements over thanks</span>
        <span class="comment">// to the fact that they don&#39;t contain a mention of the lifetime &#39;a. Tbh we need an</span>
        <span class="comment">// RFC for this, would be nice.</span>
        <span class="kw">let</span> <span class="ident">owned_config</span> <span class="op">=</span> <span class="ident">PipeListenerOptions</span> {
            <span class="ident">name</span>: <span class="ident">Cow::Owned</span>(<span class="self">self</span>.<span class="ident">name</span>.<span class="ident">clone</span>().<span class="ident">into_owned</span>()),
            <span class="ident">mode</span>: <span class="self">self</span>.<span class="ident">mode</span>,
            <span class="ident">nonblocking</span>: <span class="self">self</span>.<span class="ident">nonblocking</span>,
            <span class="ident">instance_limit</span>: <span class="self">self</span>.<span class="ident">instance_limit</span>,
            <span class="ident">write_through</span>: <span class="self">self</span>.<span class="ident">write_through</span>,
            <span class="ident">accept_remote</span>: <span class="self">self</span>.<span class="ident">accept_remote</span>,
            <span class="ident">input_buffer_size_hint</span>: <span class="self">self</span>.<span class="ident">input_buffer_size_hint</span>,
            <span class="ident">output_buffer_size_hint</span>: <span class="self">self</span>.<span class="ident">output_buffer_size_hint</span>,
            <span class="ident">wait_timeout</span>: <span class="self">self</span>.<span class="ident">wait_timeout</span>,
        };
        <span class="prelude-val">Ok</span>(<span class="ident">PipeListener</span> {
            <span class="ident">config</span>: <span class="ident">owned_config</span>,
            <span class="ident">nonblocking</span>: <span class="ident">AtomicBool::new</span>(<span class="self">self</span>.<span class="ident">nonblocking</span>),
            <span class="ident">instances</span>: <span class="ident">RwLock::new</span>({
                <span class="kw">let</span> <span class="ident">capacity</span> <span class="op">=</span> <span class="self">self</span>.<span class="ident">instance_limit</span>.<span class="ident">map_or</span>(<span class="number">8</span>, <span class="op">|</span><span class="ident">x</span><span class="op">|</span> <span class="ident">x</span>.<span class="ident">get</span>()) <span class="kw">as</span> <span class="ident">usize</span>;
                <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">vec</span> <span class="op">=</span> <span class="ident">Vec::with_capacity</span>(<span class="ident">capacity</span>);
                <span class="ident">vec</span>.<span class="ident">push</span>(<span class="ident">Arc::new</span>(
                    <span class="self">self</span>.<span class="ident">create_instance</span>::<span class="op">&lt;</span><span class="ident">Stream</span><span class="op">&gt;</span>(<span class="bool-val">true</span>, <span class="self">self</span>.<span class="ident">nonblocking</span>)<span class="question-mark">?</span>,
                ));
                <span class="ident">vec</span>
            }),
            <span class="ident">_phantom</span>: <span class="ident">PhantomData</span>,
        })
    }
}
<span class="kw">impl</span> <span class="ident">Default</span> <span class="kw">for</span> <span class="ident">PipeListenerOptions</span><span class="op">&lt;</span><span class="lifetime">&#39;_</span><span class="op">&gt;</span> {
    <span class="kw">fn</span> <span class="ident">default</span>() <span class="op">-</span><span class="op">&gt;</span> <span class="self">Self</span> {
        <span class="ident"><span class="self">Self</span>::new</span>()
    }
}

<span class="macro">macro_rules!</span> <span class="ident">create_stream_type</span> {
    ($(
        <span class="macro-nonterminal">$</span><span class="macro-nonterminal">ty</span>:<span class="ident">ident</span>:
            <span class="ident">desired_access</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">desired_access</span>:<span class="ident">expr</span>,
            <span class="ident">role</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">role</span>:<span class="ident">expr</span>,
            <span class="ident">read_mode</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">read_mode</span>:<span class="ident">expr</span>,
            <span class="ident">write_mode</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">write_mode</span>:<span class="ident">expr</span>,
            <span class="ident">doc</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">doc</span>:<span class="ident">tt</span>
    )<span class="op">+</span>) <span class="op">=</span><span class="op">&gt;</span> ($(
        <span class="attribute">#[<span class="ident">doc</span> <span class="op">=</span> <span class="macro-nonterminal">$</span><span class="macro-nonterminal">doc</span>]</span>
        <span class="kw">pub</span> <span class="kw">struct</span> <span class="macro-nonterminal">$</span><span class="macro-nonterminal">ty</span> {
            <span class="ident">instance</span>: <span class="ident">Arc</span><span class="op">&lt;</span>(<span class="ident">PipeOps</span>, <span class="ident">AtomicBool</span>)<span class="op">&gt;</span>,
        }
        <span class="kw">impl</span> <span class="macro-nonterminal">$</span><span class="macro-nonterminal">ty</span> {
            <span class="doccomment">/// Connects to an existing named pipe.</span>
            <span class="attribute">#[<span class="ident">inline</span>]</span>
            <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">connect</span>(<span class="ident">name</span>: <span class="kw">impl</span> <span class="ident">AsRef</span><span class="op">&lt;</span><span class="ident">OsStr</span><span class="op">&gt;</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="self">Self</span><span class="op">&gt;</span> {
                <span class="kw">let</span> <span class="ident">name</span> <span class="op">=</span> <span class="ident">convert_path</span>(<span class="ident">name</span>.<span class="ident">as_ref</span>());
                <span class="kw">let</span> (<span class="ident">success</span>, <span class="ident">handle</span>) <span class="op">=</span> <span class="kw">unsafe</span> {
                    <span class="kw">let</span> <span class="ident">handle</span> <span class="op">=</span> <span class="ident">CreateFileW</span>(
                        <span class="ident">name</span>.<span class="ident">as_ptr</span>() <span class="kw">as</span> <span class="kw-2">*</span><span class="kw-2">mut</span> <span class="kw">_</span>,
                        <span class="macro-nonterminal">$</span><span class="macro-nonterminal">desired_access</span>,
                        <span class="ident">FILE_SHARE_READ</span> <span class="op">|</span> <span class="ident">FILE_SHARE_WRITE</span>,
                        <span class="ident">ptr::null_mut</span>(),
                        <span class="ident">OPEN_EXISTING</span>,
                        <span class="number">0</span>,
                        <span class="ident">ptr::null_mut</span>(),
                    );
                    (<span class="ident">handle</span> <span class="op">!</span><span class="op">=</span> <span class="ident">INVALID_HANDLE_VALUE</span>, <span class="ident">handle</span>)
                };
                <span class="kw">if</span> <span class="ident">success</span> {
                    <span class="prelude-val">Ok</span>(<span class="kw">unsafe</span> {<span class="self">Self</span> {
                        <span class="comment">// SAFETY: we just created this handle, which means that</span>
                        <span class="comment">// it&#39;s not being used anywhere else</span>
                        <span class="ident">instance</span>: <span class="ident">Arc::new</span>((
                            <span class="ident">PipeOps::from_raw_handle</span>(<span class="ident">handle</span>), <span class="ident">AtomicBool::new</span>(<span class="bool-val">false</span>),
                        ))
                    }})
                } <span class="kw">else</span> {
                    <span class="prelude-val">Err</span>(<span class="ident">io::Error::last_os_error</span>())
                }
            }
            <span class="doccomment">/// Sets whether the nonblocking mode for the pipe stream is enabled. By default, it is disabled.</span>
            <span class="doccomment">///</span>
            <span class="doccomment">/// In nonblocking mode, attempts to read from the pipe when there is no data available or to write when the buffer has filled up because the receiving side did not read enough bytes in time will never block like they normally do. Instead, a [`WouldBlock`] error is immediately returned, allowing the thread to perform useful actions in the meantime.</span>
            <span class="doccomment">///</span>
            <span class="doccomment">/// *If called on the server side, the flag will be set only for one stream instance.* A listener creation option, [`nonblocking`], and a similar method on the listener, [`set_nonblocking`], can be used to set the mode in bulk for all current instances and future ones.</span>
            <span class="doccomment">///</span>
            <span class="doccomment">/// [`WouldBlock`]: https://doc.rust-lang.org/std/io/enum.ErrorKind.html#variant.WouldBlock &quot; &quot;</span>
            <span class="doccomment">/// [`nonblocking`]: struct.PipeListenerOptions.html#structfield.nonblocking &quot; &quot;</span>
            <span class="doccomment">/// [`set_nonblocking`]: struct.PipeListener.html#method.set_nonblocking &quot; &quot;</span>
            <span class="attribute">#[<span class="ident">inline</span>]</span>
            <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">set_nonblocking</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">nonblocking</span>: <span class="ident">bool</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
                <span class="kw">unsafe</span> {
                    <span class="ident">set_nonblocking_for_stream</span>::<span class="op">&lt;</span><span class="self">Self</span><span class="op">&gt;</span>(<span class="self">self</span>.<span class="ident">as_raw_handle</span>(), <span class="ident">nonblocking</span>)
                }
            }
            <span class="doccomment">/// Retrieves the process identifier of the client side of the named pipe connection.</span>
            <span class="attribute">#[<span class="ident">inline</span>]</span>
            <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">client_process_id</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="ident">u32</span><span class="op">&gt;</span> {
                <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">get_client_process_id</span>()
            }
            <span class="doccomment">/// Retrieves the session identifier of the client side of the named pipe connection.</span>
            <span class="attribute">#[<span class="ident">inline</span>]</span>
            <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">client_session_id</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="ident">u32</span><span class="op">&gt;</span> {
                <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">get_client_session_id</span>()
            }
            <span class="doccomment">/// Retrieves the process identifier of the server side of the named pipe connection.</span>
            <span class="attribute">#[<span class="ident">inline</span>]</span>
            <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">server_process_id</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="ident">u32</span><span class="op">&gt;</span> {
                <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">get_server_process_id</span>()
            }
            <span class="doccomment">/// Retrieves the session identifier of the server side of the named pipe connection.</span>
            <span class="attribute">#[<span class="ident">inline</span>]</span>
            <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">server_session_id</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="ident">u32</span><span class="op">&gt;</span> {
                <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">get_server_session_id</span>()
            }
            <span class="doccomment">/// Disconnects the named pipe stream without flushing buffers, causing all data in those buffers to be lost. This is much faster than simply dropping the stream, since the `Drop` implementation flushes first. Only makes sense for server-side pipes and will panic in debug builds if called on a client stream.</span>
            <span class="attribute">#[<span class="ident">inline</span>]</span>
            <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">disconnect_without_flushing</span>(<span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
                <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">disconnect</span>()<span class="question-mark">?</span>;
                <span class="comment">// We keep the atomic store anyway since checking whether we&#39;re a client or a server and avoiding an atomic write is potentially slower than that write.</span>
                <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">1</span>.<span class="ident">store</span>(<span class="bool-val">false</span>, <span class="ident">Ordering::Release</span>);
                <span class="kw">let</span> <span class="ident">instance</span> <span class="op">=</span> <span class="kw">unsafe</span> {
                    <span class="comment">// SAFETY: mem::forget is used to safely destroy the invalidated master copy</span>
                    <span class="ident">ptr::read</span>(<span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">instance</span>)
                };
                <span class="ident">drop</span>(<span class="ident">instance</span>);
                <span class="ident">mem::forget</span>(<span class="self">self</span>);
                <span class="prelude-val">Ok</span>(())
            }
        }
        <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">windows</span>)]</span>
        <span class="kw">impl</span> <span class="ident">PipeStream</span> <span class="kw">for</span> <span class="macro-nonterminal">$</span><span class="macro-nonterminal">ty</span> {
            <span class="kw">const</span> <span class="ident">ROLE</span>: <span class="ident">PipeStreamRole</span> <span class="op">=</span> <span class="macro-nonterminal">$</span><span class="macro-nonterminal">role</span>;
            <span class="kw">const</span> <span class="ident">WRITE_MODE</span>: <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">PipeMode</span><span class="op">&gt;</span> <span class="op">=</span> <span class="macro-nonterminal">$</span><span class="macro-nonterminal">write_mode</span>;
            <span class="kw">const</span> <span class="ident">READ_MODE</span>: <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">PipeMode</span><span class="op">&gt;</span> <span class="op">=</span> <span class="macro-nonterminal">$</span><span class="macro-nonterminal">read_mode</span>;
        }
        <span class="kw">impl</span> <span class="ident">Sealed</span> <span class="kw">for</span> <span class="macro-nonterminal">$</span><span class="macro-nonterminal">ty</span> {}
        <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">windows</span>)]</span>
        <span class="kw">impl</span> <span class="ident">NamedPipeStreamInternals</span> <span class="kw">for</span> <span class="macro-nonterminal">$</span><span class="macro-nonterminal">ty</span> {}
        <span class="kw">impl</span> <span class="ident">Drop</span> <span class="kw">for</span> <span class="macro-nonterminal">$</span><span class="macro-nonterminal">ty</span> {
            <span class="attribute">#[<span class="ident">inline</span>]</span>
            <span class="kw">fn</span> <span class="ident">drop</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>) {
                <span class="comment">// We can and should ignore the result because we can&#39;t handle it from a Drop</span>
                <span class="comment">// implementation and we can&#39;t/shouldn&#39;t handle it either</span>
                <span class="kw">let</span> <span class="kw">_</span> <span class="op">=</span> <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">flush_and_disconnect</span>();
                <span class="comment">// See note about atomics above.</span>
                <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">1</span>.<span class="ident">store</span>(<span class="bool-val">false</span>, <span class="ident">Ordering::Release</span>);
            }
        }
        <span class="attribute">#[<span class="ident">doc</span>(<span class="ident">hidden</span>)]</span>
        <span class="kw">impl</span> <span class="ident">From</span><span class="op">&lt;</span><span class="ident">Arc</span><span class="op">&lt;</span>(<span class="ident">PipeOps</span>, <span class="ident">AtomicBool</span>)<span class="op">&gt;</span><span class="op">&gt;</span> <span class="kw">for</span> <span class="macro-nonterminal">$</span><span class="macro-nonterminal">ty</span> {
            <span class="attribute">#[<span class="ident">inline</span>]</span>
            <span class="kw">fn</span> <span class="ident">from</span>(<span class="ident">instance</span>: <span class="ident">Arc</span><span class="op">&lt;</span>(<span class="ident">PipeOps</span>, <span class="ident">AtomicBool</span>)<span class="op">&gt;</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="self">Self</span> {
                <span class="self">Self</span> {<span class="ident">instance</span>}
            }
        }
        <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">windows</span>)]</span>
        <span class="kw">impl</span> <span class="ident">AsRawHandle</span> <span class="kw">for</span> <span class="macro-nonterminal">$</span><span class="macro-nonterminal">ty</span> {
            <span class="attribute">#[<span class="ident">inline</span>]</span>
            <span class="kw">fn</span> <span class="ident">as_raw_handle</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">HANDLE</span> {
                <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">as_raw_handle</span>()
            }
        }
        <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">windows</span>)]</span>
        <span class="kw">impl</span> <span class="ident">IntoRawHandle</span> <span class="kw">for</span> <span class="macro-nonterminal">$</span><span class="macro-nonterminal">ty</span> {
            <span class="attribute">#[<span class="ident">inline</span>]</span>
            <span class="kw">fn</span> <span class="ident">into_raw_handle</span>(<span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">HANDLE</span> {
                <span class="kw">let</span> <span class="ident">handle</span> <span class="op">=</span> <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">as_raw_handle</span>();
                <span class="ident">handle</span>
            }
        }
        <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">windows</span>)]</span>
        <span class="kw">impl</span> <span class="ident">FromRawHandle</span> <span class="kw">for</span> <span class="macro-nonterminal">$</span><span class="macro-nonterminal">ty</span> {
            <span class="attribute">#[<span class="ident">inline</span>]</span>
            <span class="kw">unsafe</span> <span class="kw">fn</span> <span class="ident">from_raw_handle</span>(<span class="ident">handle</span>: <span class="ident">HANDLE</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="self">Self</span> {
                <span class="self">Self</span> {
                    <span class="ident">instance</span>: <span class="ident">Arc::new</span>((
                        <span class="ident">PipeOps::from_raw_handle</span>(<span class="ident">handle</span>),
                        <span class="ident">AtomicBool::new</span>(<span class="bool-val">false</span>),
                    ))
                }
            }
        }
        <span class="kw">impl</span> <span class="ident">Debug</span> <span class="kw">for</span> <span class="macro-nonterminal">$</span><span class="macro-nonterminal">ty</span> {
            <span class="attribute">#[<span class="ident">inline</span>]</span>
            <span class="kw">fn</span> <span class="ident">fmt</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">f</span>: <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">Formatter</span><span class="op">&lt;</span><span class="lifetime">&#39;_</span><span class="op">&gt;</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">fmt::Result</span> {
                <span class="ident">f</span>.<span class="ident">debug_struct</span>(<span class="macro">stringify!</span>(<span class="macro-nonterminal">$</span><span class="macro-nonterminal">ty</span>))
                    .<span class="ident">field</span>(<span class="string">&quot;handle&quot;</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">as_raw_handle</span>())
                    .<span class="ident">finish</span>()
            }
        }
    )<span class="op">+</span>);
}
<span class="macro">create_stream_type!</span> {
    <span class="ident">ByteReaderPipeStream</span>:
        <span class="ident">desired_access</span>: <span class="ident">GENERIC_READ</span>,
        <span class="ident">role</span>: <span class="ident">PipeStreamRole::Reader</span>,
        <span class="ident">read_mode</span>: <span class="prelude-val">Some</span>(<span class="ident">PipeMode::Bytes</span>),
        <span class="ident">write_mode</span>: <span class="prelude-val">None</span>,
        <span class="ident">doc</span>: <span class="string">&quot;
[Byte stream reader] for a named pipe.

Created either by using `PipeListener` or by connecting to a named pipe server.

[Byte stream reader]: https://doc.rust-lang.org/std/io/trait.Read.html
&quot;</span>
    <span class="ident">ByteWriterPipeStream</span>:
        <span class="ident">desired_access</span>: <span class="ident">GENERIC_WRITE</span>,
        <span class="ident">role</span>: <span class="ident">PipeStreamRole::Writer</span>,
        <span class="ident">read_mode</span>: <span class="prelude-val">None</span>,
        <span class="ident">write_mode</span>: <span class="prelude-val">Some</span>(<span class="ident">PipeMode::Bytes</span>),
        <span class="ident">doc</span>: <span class="string">&quot;
[Byte stream writer] for a named pipe.

Created either by using `PipeListener` or by connecting to a named pipe server.

[Byte stream writer]: https://doc.rust-lang.org/std/io/trait.Write.html
&quot;</span>
    <span class="ident">DuplexBytePipeStream</span>:
        <span class="ident">desired_access</span>: <span class="ident">GENERIC_READ</span> <span class="op">|</span> <span class="ident">GENERIC_WRITE</span>,
        <span class="ident">role</span>: <span class="ident">PipeStreamRole::ReaderAndWriter</span>,
        <span class="ident">read_mode</span>: <span class="prelude-val">Some</span>(<span class="ident">PipeMode::Bytes</span>),
        <span class="ident">write_mode</span>: <span class="prelude-val">Some</span>(<span class="ident">PipeMode::Bytes</span>),
        <span class="ident">doc</span>: <span class="string">&quot;
Byte stream [reader] and [writer] for a named pipe.

Created either by using `PipeListener` or by connecting to a named pipe server.

[reader]: https://doc.rust-lang.org/std/io/trait.Read.html
[writer]: https://doc.rust-lang.org/std/io/trait.Write.html
&quot;</span>
    <span class="ident">MsgReaderPipeStream</span>:
        <span class="ident">desired_access</span>: <span class="ident">GENERIC_READ</span>,
        <span class="ident">role</span>: <span class="ident">PipeStreamRole::Reader</span>,
        <span class="ident">read_mode</span>: <span class="prelude-val">Some</span>(<span class="ident">PipeMode::Messages</span>),
        <span class="ident">write_mode</span>: <span class="prelude-val">None</span>,
        <span class="ident">doc</span>: <span class="string">&quot;
[Message stream reader] for a named pipe.

Created either by using `PipeListener` or by connecting to a named pipe server.

[Message stream reader]: https://doc.rust-lang.org/std/io/trait.Read.html
&quot;</span>
    <span class="ident">MsgWriterPipeStream</span>:
        <span class="ident">desired_access</span>: <span class="ident">GENERIC_WRITE</span>,
        <span class="ident">role</span>: <span class="ident">PipeStreamRole::Writer</span>,
        <span class="ident">read_mode</span>: <span class="prelude-val">None</span>,
        <span class="ident">write_mode</span>: <span class="prelude-val">Some</span>(<span class="ident">PipeMode::Messages</span>),
        <span class="ident">doc</span>: <span class="string">&quot;
[Message stream writer] for a named pipe.

Created either by using `PipeListener` or by connecting to a named pipe server.

[Message stream writer]: https://doc.rust-lang.org/std/io/trait.Write.html
&quot;</span>
    <span class="ident">DuplexMsgPipeStream</span>:
    <span class="ident">desired_access</span>: <span class="ident">GENERIC_READ</span> <span class="op">|</span> <span class="ident">GENERIC_WRITE</span>,
    <span class="ident">role</span>: <span class="ident">PipeStreamRole::ReaderAndWriter</span>,
    <span class="ident">read_mode</span>: <span class="prelude-val">Some</span>(<span class="ident">PipeMode::Messages</span>),
    <span class="ident">write_mode</span>: <span class="prelude-val">Some</span>(<span class="ident">PipeMode::Messages</span>),
    <span class="ident">doc</span>: <span class="string">&quot;
Message stream [reader] and [writer] for a named pipe.

Created either by using `PipeListener` or by connecting to a named pipe server.

[reader]: https://doc.rust-lang.org/std/io/trait.Read.html
[writer]: https://doc.rust-lang.org/std/io/trait.Write.html
&quot;</span>
}

<span class="kw">impl</span> <span class="ident">Read</span> <span class="kw">for</span> <span class="ident">ByteReaderPipeStream</span> {
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">fn</span> <span class="ident">read</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">buf</span>: <span class="kw-2">&amp;</span><span class="kw-2">mut</span> [<span class="ident">u8</span>]) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="ident">usize</span><span class="op">&gt;</span> {
        <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">read_bytes</span>(<span class="ident">buf</span>)
    }
}

<span class="kw">impl</span> <span class="ident">Write</span> <span class="kw">for</span> <span class="ident">ByteWriterPipeStream</span> {
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">fn</span> <span class="ident">write</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">buf</span>: <span class="kw-2">&amp;</span>[<span class="ident">u8</span>]) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="ident">usize</span><span class="op">&gt;</span> {
        <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">write</span>(<span class="ident">buf</span>)
    }
    <span class="kw">fn</span> <span class="ident">flush</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
        <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">flush</span>()
    }
}

<span class="kw">impl</span> <span class="ident">Read</span> <span class="kw">for</span> <span class="ident">DuplexBytePipeStream</span> {
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">fn</span> <span class="ident">read</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">buf</span>: <span class="kw-2">&amp;</span><span class="kw-2">mut</span> [<span class="ident">u8</span>]) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="ident">usize</span><span class="op">&gt;</span> {
        <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">read_bytes</span>(<span class="ident">buf</span>)
    }
}
<span class="kw">impl</span> <span class="ident">Write</span> <span class="kw">for</span> <span class="ident">DuplexBytePipeStream</span> {
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">fn</span> <span class="ident">write</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">buf</span>: <span class="kw-2">&amp;</span>[<span class="ident">u8</span>]) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="ident">usize</span><span class="op">&gt;</span> {
        <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">write</span>(<span class="ident">buf</span>)
    }
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">fn</span> <span class="ident">flush</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
        <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">flush</span>()
    }
}

<span class="kw">impl</span> <span class="ident">Read</span> <span class="kw">for</span> <span class="ident">MsgReaderPipeStream</span> {
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">fn</span> <span class="ident">read</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">buf</span>: <span class="kw-2">&amp;</span><span class="kw-2">mut</span> [<span class="ident">u8</span>]) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="ident">usize</span><span class="op">&gt;</span> {
        <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">read_bytes</span>(<span class="ident">buf</span>)
    }
}
<span class="kw">impl</span> <span class="ident">ReliableReadMsg</span> <span class="kw">for</span> <span class="ident">MsgReaderPipeStream</span> {
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">fn</span> <span class="ident">read_msg</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">buf</span>: <span class="kw-2">&amp;</span><span class="kw-2">mut</span> [<span class="ident">u8</span>]) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">usize</span>, <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u8</span><span class="op">&gt;</span><span class="op">&gt;</span><span class="op">&gt;</span> {
        <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">read_msg</span>(<span class="ident">buf</span>)
    }
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">fn</span> <span class="ident">try_read_msg</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">buf</span>: <span class="kw-2">&amp;</span><span class="kw-2">mut</span> [<span class="ident">u8</span>]) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">usize</span>, <span class="ident">usize</span><span class="op">&gt;</span><span class="op">&gt;</span> {
        <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">try_read_msg</span>(<span class="ident">buf</span>)
    }
}

<span class="kw">impl</span> <span class="ident">Write</span> <span class="kw">for</span> <span class="ident">MsgWriterPipeStream</span> {
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">fn</span> <span class="ident">write</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">buf</span>: <span class="kw-2">&amp;</span>[<span class="ident">u8</span>]) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="ident">usize</span><span class="op">&gt;</span> {
        <span class="kw">if</span> <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">write</span>(<span class="ident">buf</span>)<span class="question-mark">?</span> <span class="op">=</span><span class="op">=</span> <span class="ident">buf</span>.<span class="ident">len</span>() {
            <span class="prelude-val">Ok</span>(<span class="ident">buf</span>.<span class="ident">len</span>())
        } <span class="kw">else</span> {
            <span class="prelude-val">Err</span>(<span class="ident">io::Error::new</span>(<span class="ident">io::ErrorKind::Other</span>, <span class="ident">PartialMsgWriteError</span>))
        }
    }
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">fn</span> <span class="ident">flush</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
        <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">flush</span>()
    }
}

<span class="kw">impl</span> <span class="ident">Read</span> <span class="kw">for</span> <span class="ident">DuplexMsgPipeStream</span> {
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">fn</span> <span class="ident">read</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">buf</span>: <span class="kw-2">&amp;</span><span class="kw-2">mut</span> [<span class="ident">u8</span>]) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="ident">usize</span><span class="op">&gt;</span> {
        <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">read_bytes</span>(<span class="ident">buf</span>)
    }
}
<span class="kw">impl</span> <span class="ident">ReliableReadMsg</span> <span class="kw">for</span> <span class="ident">DuplexMsgPipeStream</span> {
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">fn</span> <span class="ident">read_msg</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">buf</span>: <span class="kw-2">&amp;</span><span class="kw-2">mut</span> [<span class="ident">u8</span>]) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">usize</span>, <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u8</span><span class="op">&gt;</span><span class="op">&gt;</span><span class="op">&gt;</span> {
        <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">read_msg</span>(<span class="ident">buf</span>)
    }
    <span class="kw">fn</span> <span class="ident">try_read_msg</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">buf</span>: <span class="kw-2">&amp;</span><span class="kw-2">mut</span> [<span class="ident">u8</span>]) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">usize</span>, <span class="ident">usize</span><span class="op">&gt;</span><span class="op">&gt;</span> {
        <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">try_read_msg</span>(<span class="ident">buf</span>)
    }
}
<span class="kw">impl</span> <span class="ident">Write</span> <span class="kw">for</span> <span class="ident">DuplexMsgPipeStream</span> {
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">fn</span> <span class="ident">write</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">buf</span>: <span class="kw-2">&amp;</span>[<span class="ident">u8</span>]) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="ident">usize</span><span class="op">&gt;</span> {
        <span class="kw">if</span> <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">write</span>(<span class="ident">buf</span>)<span class="question-mark">?</span> <span class="op">=</span><span class="op">=</span> <span class="ident">buf</span>.<span class="ident">len</span>() {
            <span class="prelude-val">Ok</span>(<span class="ident">buf</span>.<span class="ident">len</span>())
        } <span class="kw">else</span> {
            <span class="prelude-val">Err</span>(<span class="ident">io::Error::new</span>(<span class="ident">io::ErrorKind::Other</span>, <span class="ident">PartialMsgWriteError</span>))
        }
    }
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">fn</span> <span class="ident">flush</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
        <span class="self">self</span>.<span class="ident">instance</span>.<span class="number">0</span>.<span class="ident">flush</span>()
    }
}

<span class="doccomment">/// Defines the properties of pipe stream types.</span>
<span class="doccomment">///</span>
<span class="doccomment">/// ## Why there are multiple types of pipe streams</span>
<span class="doccomment">/// One of the similarities between Unix domain sockets and Windows named pipes is how both can be used in datagram mode and in byte stream mode, that is, like with sockets, Windows named pipes can both maintain the boundaries between packets or erase those boundaries — the specific behavior can be controlled both during pipe creation and during connection. The reader can still use the stream interface even if the writer maintains datagram boundaries, and vice versa: the system automatically disassembles the datagrams into a byte stream with virtually no cost.</span>
<span class="doccomment">///</span>
<span class="doccomment">/// The distinction between datagram-oriented connections and byte streams exists for symmetry with the standard library, where UDP and TCP sockets are represented by different types. The idea behind this is that by separating the two semantic types of sockets into two types, the distinction between those semantics can be enforced at compile time instead of using runtime errors to signal that, for example, a datagram read operation is attempted on a byte stream.</span>
<span class="doccomment">///</span>
<span class="doccomment">/// The fact that named pipes can have different data flow directions further increases the amount of various stream types. By restricting the implemented stream traits at compile time, named pipe streams can be used correctly in generic contexts unaware of named pipes without extra runtime checking for the correct pipe direction.</span>
<span class="kw">pub</span> <span class="kw">trait</span> <span class="ident">PipeStream</span>:
    <span class="ident">AsRawHandle</span> <span class="op">+</span> <span class="ident">IntoRawHandle</span> <span class="op">+</span> <span class="ident">FromRawHandle</span> <span class="op">+</span> <span class="ident">NamedPipeStreamInternals</span>
{
    <span class="doccomment">/// The data stream flow direction for the pipe. See the [`PipeStreamRole`] enumeration for more on what this means.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// [`PipeStreamRole`]: enum.PipeStreamRole.html &quot; &quot;</span>
    <span class="kw">const</span> <span class="ident">ROLE</span>: <span class="ident">PipeStreamRole</span>;
    <span class="doccomment">/// The data stream mode for the pipe. If set to `PipeMode::Bytes`, message boundaries will broken and having `READ_MODE` at `PipeMode::Messages` would be a pipe creation error.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// For reader streams, this value has no meaning: if the reader stream belongs to the server (client sends data, server receives), then `READ_MODE` takes the role of this value; if the reader stream belongs to the client, there is no visible difference to how the server writes data since the client specifies its read mode itself anyway.</span>
    <span class="kw">const</span> <span class="ident">WRITE_MODE</span>: <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">PipeMode</span><span class="op">&gt;</span>;
    <span class="doccomment">/// The data stream mode used when reading from the pipe: if `WRITE_MODE` is `PipeMode::Messages` and `READ_MODE` is `PipeMode::Bytes`, the message boundaries will be destroyed when reading even though they are retained when written. See the `PipeMode` enumeration for more on what those modes mean.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// For writer streams, this value has no meaning: if the writer stream belongs to the server (server sends data, client receives), then the server doesn&#39;t read data at all and thus this does not affect anything; if the writer stream belongs to the client, then the client doesn&#39;t read anything and the value is meaningless as well.</span>
    <span class="kw">const</span> <span class="ident">READ_MODE</span>: <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">PipeMode</span><span class="op">&gt;</span>;
}

<span class="doccomment">/// Connects to the specified named pipe, returning a named pipe stream of the stream type provided via generic parameters.</span>
<span class="doccomment">///</span>
<span class="doccomment">/// Since named pipes can work across multiple machines, an optional hostname can be supplied. Leave it at `None` if you&#39;re using named pipes on the local machine exclusively, which is most likely the case.</span>
<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">connect</span><span class="op">&lt;</span><span class="ident">Stream</span>: <span class="ident">PipeStream</span><span class="op">&gt;</span>(
    <span class="ident">pipe_name</span>: <span class="kw">impl</span> <span class="ident">AsRef</span><span class="op">&lt;</span><span class="ident">OsStr</span><span class="op">&gt;</span>,
    <span class="ident">hostname</span>: <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="kw">impl</span> <span class="ident">AsRef</span><span class="op">&lt;</span><span class="ident">OsStr</span><span class="op">&gt;</span><span class="op">&gt;</span>,
) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">io::Result</span><span class="op">&lt;</span><span class="ident">Stream</span><span class="op">&gt;</span> {
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">path</span> <span class="op">=</span> {
        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">path</span> <span class="op">=</span> <span class="ident">OsString::from</span>(<span class="string">r&quot;\\.&quot;</span>);
        <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="ident">host</span>) <span class="op">=</span> <span class="ident">hostname</span> {
            <span class="ident">path</span>.<span class="ident">push</span>(<span class="ident">host</span>);
        } <span class="kw">else</span> {
            <span class="ident">path</span>.<span class="ident">push</span>(<span class="string">&quot;.&quot;</span>);
        }
        <span class="ident">path</span>.<span class="ident">push</span>(<span class="string">r&quot;\pipe\&quot;</span>);
        <span class="ident">path</span>.<span class="ident">push</span>(<span class="ident">pipe_name</span>.<span class="ident">as_ref</span>());
        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">path</span> <span class="op">=</span> <span class="ident">path</span>.<span class="ident">encode_wide</span>().<span class="ident">collect</span>::<span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u16</span><span class="op">&gt;</span><span class="op">&gt;</span>();
        <span class="ident">path</span>.<span class="ident">push</span>(<span class="number">0</span>);
        <span class="ident">path</span>
    };
    <span class="kw">let</span> (<span class="ident">success</span>, <span class="ident">handle</span>) <span class="op">=</span> <span class="kw">unsafe</span> {
        <span class="kw">let</span> <span class="ident">handle</span> <span class="op">=</span> <span class="ident">CreateFileW</span>(
            <span class="ident">path</span>.<span class="ident">as_mut_ptr</span>() <span class="kw">as</span> <span class="kw-2">*</span><span class="kw-2">mut</span> <span class="kw">_</span>,
            {
                <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">access_flags</span>: <span class="ident">DWORD</span> <span class="op">=</span> <span class="number">0</span>;
                <span class="kw">if</span> <span class="ident">Stream::READ_MODE</span>.<span class="ident">is_some</span>() {
                    <span class="ident">access_flags</span> <span class="op">|</span><span class="op">=</span> <span class="ident">GENERIC_READ</span>;
                }
                <span class="kw">if</span> <span class="ident">Stream::WRITE_MODE</span>.<span class="ident">is_some</span>() {
                    <span class="ident">access_flags</span> <span class="op">|</span><span class="op">=</span> <span class="ident">GENERIC_WRITE</span>;
                }
                <span class="ident">access_flags</span>
            },
            <span class="number">0</span>,
            <span class="ident">ptr::null_mut</span>(),
            <span class="ident">OPEN_EXISTING</span>,
            <span class="number">0</span>,
            <span class="ident">ptr::null_mut</span>(),
        );
        (<span class="ident">handle</span> <span class="op">!</span><span class="op">=</span> <span class="ident">INVALID_HANDLE_VALUE</span>, <span class="ident">handle</span>)
    };
    <span class="kw">if</span> <span class="ident">success</span> {
        <span class="prelude-val">Ok</span>(<span class="ident">Stream::from</span>(<span class="ident">Arc::from</span>((
            <span class="kw">unsafe</span> { <span class="ident">PipeOps::from_raw_handle</span>(<span class="ident">handle</span>) }, <span class="comment">// SAFETY: we just created this handle</span>
            <span class="ident">AtomicBool::new</span>(<span class="bool-val">true</span>),
        ))))
    } <span class="kw">else</span> {
        <span class="prelude-val">Err</span>(<span class="ident">io::Error::last_os_error</span>())
    }
}

<span class="doccomment">/// The direction of a named pipe connection, designating who can read data and who can write it. This describes the direction of the data flow unambiguously, so that the meaning of the values is the same for the client and server — [`ClientToServer`] always means client → server, for example.</span>
<span class="doccomment">///</span>
<span class="doccomment">/// [`ClientToServer`]: enum.PipeDirection.html#variant.ClientToServer &quot; &quot;</span>
<span class="comment">// I had to type out both the link to the page and the name of the variant since the link can be clicked from module-level documentation so please don&#39;t touch it.</span>
<span class="attribute">#[<span class="ident">repr</span>(<span class="ident">u32</span>)]</span>
<span class="comment">// We depend on the fact that DWORD always maps to u32, which, thankfully, will always stay true</span>
<span class="comment">// since the public WinAPI is supposed to be ABI-compatible. Just keep in mind that the</span>
<span class="comment">// #[repr(u32)] means that we can transmute this enumeration to the Windows DWORD type.</span>
<span class="attribute">#[<span class="ident">derive</span>(<span class="ident">Copy</span>, <span class="ident">Clone</span>, <span class="ident">Debug</span>, <span class="ident">PartialEq</span>, <span class="ident">Eq</span>, <span class="ident">Hash</span>)]</span>
<span class="kw">pub</span> <span class="kw">enum</span> <span class="ident">PipeDirection</span> {
    <span class="doccomment">/// Represents a server ← client data flow: clients write data, the server reads it.</span>
    <span class="ident">ClientToServer</span> <span class="op">=</span> <span class="ident">PIPE_ACCESS_INBOUND</span>,
    <span class="doccomment">/// Represents a server → client data flow: the server writes data, clients read it.</span>
    <span class="ident">ServerToClient</span> <span class="op">=</span> <span class="ident">PIPE_ACCESS_OUTBOUND</span>,
    <span class="doccomment">/// Represents a server ⇄ client data flow: the server can write data which then is read by the client, while the client writes data which is read by the server.</span>
    <span class="ident">Duplex</span> <span class="op">=</span> <span class="ident">PIPE_ACCESS_DUPLEX</span>,
}
<span class="kw">impl</span> <span class="ident">PipeDirection</span> {
    <span class="doccomment">/// Returns the role which the pipe client will have in this direction setting.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// # Usage</span>
    <span class="doccomment">/// ```</span>
    <span class="doccomment">/// # #[cfg(windows)] {</span>
    <span class="doccomment">/// # use interprocess::os::windows::named_pipe::{PipeDirection, PipeStreamRole};</span>
    <span class="doccomment">/// assert_eq!(</span>
    <span class="doccomment">///     PipeDirection::ClientToServer.client_role(),</span>
    <span class="doccomment">///     PipeStreamRole::Writer,</span>
    <span class="doccomment">/// );</span>
    <span class="doccomment">/// assert_eq!(</span>
    <span class="doccomment">///     PipeDirection::ServerToClient.client_role(),</span>
    <span class="doccomment">///     PipeStreamRole::Reader,</span>
    <span class="doccomment">/// );</span>
    <span class="doccomment">/// assert_eq!(</span>
    <span class="doccomment">///     PipeDirection::Duplex.client_role(),</span>
    <span class="doccomment">///     PipeStreamRole::ReaderAndWriter,</span>
    <span class="doccomment">/// );</span>
    <span class="doccomment">/// # }</span>
    <span class="doccomment">/// ```</span>
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">pub</span> <span class="kw">const</span> <span class="kw">fn</span> <span class="ident">client_role</span>(<span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">PipeStreamRole</span> {
        <span class="kw">match</span> <span class="self">self</span> {
            <span class="ident"><span class="self">Self</span>::ClientToServer</span> <span class="op">=</span><span class="op">&gt;</span> <span class="ident">PipeStreamRole::Writer</span>,
            <span class="ident"><span class="self">Self</span>::ServerToClient</span> <span class="op">=</span><span class="op">&gt;</span> <span class="ident">PipeStreamRole::Reader</span>,
            <span class="ident"><span class="self">Self</span>::Duplex</span> <span class="op">=</span><span class="op">&gt;</span> <span class="ident">PipeStreamRole::ReaderAndWriter</span>,
        }
    }
    <span class="doccomment">/// Returns the role which the pipe server will have in this direction setting.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// # Usage</span>
    <span class="doccomment">/// ```</span>
    <span class="doccomment">/// # #[cfg(windows)] {</span>
    <span class="doccomment">/// # use interprocess::os::windows::named_pipe::{PipeDirection, PipeStreamRole};</span>
    <span class="doccomment">/// assert_eq!(</span>
    <span class="doccomment">///     PipeDirection::ClientToServer.server_role(),</span>
    <span class="doccomment">///     PipeStreamRole::Reader,</span>
    <span class="doccomment">/// );</span>
    <span class="doccomment">/// assert_eq!(</span>
    <span class="doccomment">///     PipeDirection::ServerToClient.server_role(),</span>
    <span class="doccomment">///     PipeStreamRole::Writer,</span>
    <span class="doccomment">/// );</span>
    <span class="doccomment">/// assert_eq!(</span>
    <span class="doccomment">///     PipeDirection::Duplex.server_role(),</span>
    <span class="doccomment">///     PipeStreamRole::ReaderAndWriter,</span>
    <span class="doccomment">/// );</span>
    <span class="doccomment">/// # }</span>
    <span class="doccomment">/// ```</span>
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">pub</span> <span class="kw">const</span> <span class="kw">fn</span> <span class="ident">server_role</span>(<span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">PipeStreamRole</span> {
        <span class="kw">match</span> <span class="self">self</span> {
            <span class="ident"><span class="self">Self</span>::ClientToServer</span> <span class="op">=</span><span class="op">&gt;</span> <span class="ident">PipeStreamRole::Reader</span>,
            <span class="ident"><span class="self">Self</span>::ServerToClient</span> <span class="op">=</span><span class="op">&gt;</span> <span class="ident">PipeStreamRole::Writer</span>,
            <span class="ident"><span class="self">Self</span>::Duplex</span> <span class="op">=</span><span class="op">&gt;</span> <span class="ident">PipeStreamRole::ReaderAndWriter</span>,
        }
    }
}
<span class="kw">impl</span> <span class="ident">TryFrom</span><span class="op">&lt;</span><span class="ident">DWORD</span><span class="op">&gt;</span> <span class="kw">for</span> <span class="ident">PipeDirection</span> {
    <span class="kw">type</span> <span class="ident">Error</span> <span class="op">=</span> ();
    <span class="doccomment">/// Converts a Windows constant to a `PipeDirection` if it&#39;s in range.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// # Errors</span>
    <span class="doccomment">/// Returns `Err` if the value is not a valid pipe direction constant.</span>
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">fn</span> <span class="ident">try_from</span>(<span class="ident">op</span>: <span class="ident">DWORD</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="self">Self</span>, ()<span class="op">&gt;</span> {
        <span class="macro">assert!</span>((<span class="number">1</span>..<span class="op">=</span><span class="number">3</span>).<span class="ident">contains</span>(<span class="kw-2">&amp;</span><span class="ident">op</span>));
        <span class="comment">// See the comment block above for why this is safe.</span>
        <span class="kw">unsafe</span> { <span class="ident">mem::transmute</span>(<span class="ident">op</span>) }
    }
}
<span class="kw">impl</span> <span class="ident">From</span><span class="op">&lt;</span><span class="ident">PipeDirection</span><span class="op">&gt;</span> <span class="kw">for</span> <span class="ident">DWORD</span> {
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">fn</span> <span class="ident">from</span>(<span class="ident">op</span>: <span class="ident">PipeDirection</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="self">Self</span> {
        <span class="kw">unsafe</span> { <span class="ident">mem::transmute</span>(<span class="ident">op</span>) }
    }
}
<span class="doccomment">/// Describes the role of a named pipe stream. In constrast to [`PipeDirection`], the meaning of values here is relative — for example, [`Reader`] means [`ServerToClient`] if you&#39;re creating a server and [`ClientToServer`] if you&#39;re creating a client.</span>
<span class="doccomment">///</span>
<span class="doccomment">/// This enumeration is also not layout-compatible with the `PIPE_ACCESS_*` constants, in contrast to [`PipeDirection`].</span>
<span class="doccomment">///</span>
<span class="doccomment">/// [`PipeDirection`]: enum.PipeDirection.html &quot; &quot;</span>
<span class="doccomment">/// [`Reader`]: #variant.Reader &quot; &quot;</span>
<span class="doccomment">/// [`ServerToClient`]: enum.PipeDirection.html#variant.ServerToClient &quot; &quot;</span>
<span class="doccomment">/// [`ClientToServer`]: enum.PipeDirection.html#variant.ClientToServer &quot; &quot;</span>
<span class="attribute">#[<span class="ident">derive</span>(<span class="ident">Copy</span>, <span class="ident">Clone</span>, <span class="ident">Debug</span>, <span class="ident">PartialEq</span>, <span class="ident">Eq</span>, <span class="ident">Hash</span>)]</span>
<span class="attribute">#[<span class="ident">repr</span>(<span class="ident">u32</span>)]</span>
<span class="kw">pub</span> <span class="kw">enum</span> <span class="ident">PipeStreamRole</span> {
    <span class="doccomment">/// The stream only reads data.</span>
    <span class="ident">Reader</span>,
    <span class="doccomment">/// The stream only writes data.</span>
    <span class="ident">Writer</span>,
    <span class="doccomment">/// The stream both reads and writes data.</span>
    <span class="ident">ReaderAndWriter</span>,
}
<span class="kw">impl</span> <span class="ident">PipeStreamRole</span> {
    <span class="doccomment">/// Returns the data flow direction of the data stream, assuming that the value describes the role of the server.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// # Usage</span>
    <span class="doccomment">/// ```</span>
    <span class="doccomment">/// # #[cfg(windows)] {</span>
    <span class="doccomment">/// # use interprocess::os::windows::named_pipe::{PipeDirection, PipeStreamRole};</span>
    <span class="doccomment">/// assert_eq!(</span>
    <span class="doccomment">///     PipeStreamRole::Reader.direction_as_server(),</span>
    <span class="doccomment">///     PipeDirection::ClientToServer,</span>
    <span class="doccomment">/// );</span>
    <span class="doccomment">/// assert_eq!(</span>
    <span class="doccomment">///     PipeStreamRole::Writer.direction_as_server(),</span>
    <span class="doccomment">///     PipeDirection::ServerToClient,</span>
    <span class="doccomment">/// );</span>
    <span class="doccomment">/// assert_eq!(</span>
    <span class="doccomment">///     PipeStreamRole::ReaderAndWriter.direction_as_server(),</span>
    <span class="doccomment">///     PipeDirection::Duplex,</span>
    <span class="doccomment">/// );</span>
    <span class="doccomment">/// # }</span>
    <span class="doccomment">/// ```</span>
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">pub</span> <span class="kw">const</span> <span class="kw">fn</span> <span class="ident">direction_as_server</span>(<span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">PipeDirection</span> {
        <span class="kw">match</span> <span class="self">self</span> {
            <span class="ident"><span class="self">Self</span>::Reader</span> <span class="op">=</span><span class="op">&gt;</span> <span class="ident">PipeDirection::ClientToServer</span>,
            <span class="ident"><span class="self">Self</span>::Writer</span> <span class="op">=</span><span class="op">&gt;</span> <span class="ident">PipeDirection::ServerToClient</span>,
            <span class="ident"><span class="self">Self</span>::ReaderAndWriter</span> <span class="op">=</span><span class="op">&gt;</span> <span class="ident">PipeDirection::Duplex</span>,
        }
    }
    <span class="doccomment">/// Returns the data flow direction of the data stream, assuming that the value describes the role of the client.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// # Usage</span>
    <span class="doccomment">/// ```</span>
    <span class="doccomment">/// # #[cfg(windows)] {</span>
    <span class="doccomment">/// # use interprocess::os::windows::named_pipe::{PipeDirection, PipeStreamRole};</span>
    <span class="doccomment">/// assert_eq!(</span>
    <span class="doccomment">///     PipeStreamRole::Reader.direction_as_client(),</span>
    <span class="doccomment">///     PipeDirection::ServerToClient,</span>
    <span class="doccomment">/// );</span>
    <span class="doccomment">/// assert_eq!(</span>
    <span class="doccomment">///     PipeStreamRole::Writer.direction_as_client(),</span>
    <span class="doccomment">///     PipeDirection::ClientToServer,</span>
    <span class="doccomment">/// );</span>
    <span class="doccomment">/// assert_eq!(</span>
    <span class="doccomment">///     PipeStreamRole::ReaderAndWriter.direction_as_client(),</span>
    <span class="doccomment">///     PipeDirection::Duplex,</span>
    <span class="doccomment">/// );</span>
    <span class="doccomment">/// # }</span>
    <span class="doccomment">/// ```</span>
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">pub</span> <span class="kw">const</span> <span class="kw">fn</span> <span class="ident">direction_as_client</span>(<span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">PipeDirection</span> {
        <span class="kw">match</span> <span class="self">self</span> {
            <span class="ident"><span class="self">Self</span>::Reader</span> <span class="op">=</span><span class="op">&gt;</span> <span class="ident">PipeDirection::ServerToClient</span>,
            <span class="ident"><span class="self">Self</span>::Writer</span> <span class="op">=</span><span class="op">&gt;</span> <span class="ident">PipeDirection::ClientToServer</span>,
            <span class="ident"><span class="self">Self</span>::ReaderAndWriter</span> <span class="op">=</span><span class="op">&gt;</span> <span class="ident">PipeDirection::Duplex</span>,
        }
    }
}

<span class="doccomment">/// Specifies the mode for a pipe stream.</span>
<span class="attribute">#[<span class="ident">repr</span>(<span class="ident">u32</span>)]</span>
<span class="attribute">#[<span class="ident">derive</span>(<span class="ident">Copy</span>, <span class="ident">Clone</span>, <span class="ident">Debug</span>, <span class="ident">PartialEq</span>, <span class="ident">Eq</span>, <span class="ident">Hash</span>)]</span>
<span class="kw">pub</span> <span class="kw">enum</span> <span class="ident">PipeMode</span> {
    <span class="doccomment">/// Designates that the pipe stream works in byte stream mode, erasing the boundaries of separate messages.</span>
    <span class="ident">Bytes</span> <span class="op">=</span> <span class="ident">PIPE_TYPE_BYTE</span>,
    <span class="doccomment">/// Designates that the pipe stream works in message stream mode, preserving the boundaries of separate messages yet still allowing to read them in byte stream mode.</span>
    <span class="ident">Messages</span> <span class="op">=</span> <span class="ident">PIPE_TYPE_MESSAGE</span>,
}
<span class="kw">impl</span> <span class="ident">PipeMode</span> {
    <span class="doccomment">/// Converts the value into a raw `DWORD`-typed constant, either `PIPE_TYPE_BYTE` or `PIPE_TYPE_MESSAGE` depending on the value.</span>
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">pub</span> <span class="kw">const</span> <span class="kw">fn</span> <span class="ident">to_pipe_type</span>(<span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">DWORD</span> {
        <span class="self">self</span> <span class="kw">as</span> <span class="kw">_</span>
    }
    <span class="doccomment">/// Converts the value into a raw `DWORD`-typed constant, either `PIPE_READMODE_BYTE` or `PIPE_READMODE_MESSAGE` depending on the value.</span>
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">pub</span> <span class="kw">const</span> <span class="kw">fn</span> <span class="ident">to_readmode</span>(<span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">DWORD</span> {
        <span class="kw">match</span> <span class="self">self</span> {
            <span class="ident"><span class="self">Self</span>::Bytes</span> <span class="op">=</span><span class="op">&gt;</span> <span class="ident">PIPE_READMODE_BYTE</span>,
            <span class="ident"><span class="self">Self</span>::Messages</span> <span class="op">=</span><span class="op">&gt;</span> <span class="ident">PIPE_READMODE_MESSAGE</span>,
        }
    }
}
<span class="kw">impl</span> <span class="ident">TryFrom</span><span class="op">&lt;</span><span class="ident">DWORD</span><span class="op">&gt;</span> <span class="kw">for</span> <span class="ident">PipeMode</span> {
    <span class="kw">type</span> <span class="ident">Error</span> <span class="op">=</span> ();
    <span class="doccomment">/// Converts a Windows constant to a `PipeMode` if it&#39;s in range. Both `PIPE_TYPE_*` and `PIPE_READMODE_*` are supported.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// # Errors</span>
    <span class="doccomment">/// Returns `Err` if the value is not a valid pipe stream mode constant.</span>
    <span class="attribute">#[<span class="ident">inline</span>]</span>
    <span class="kw">fn</span> <span class="ident">try_from</span>(<span class="ident">op</span>: <span class="ident">DWORD</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="self">Self</span>, ()<span class="op">&gt;</span> {
        <span class="comment">// It&#39;s nicer to only match than to check and transmute</span>
        <span class="kw">match</span> <span class="ident">op</span> {
            <span class="ident">PIPE_TYPE_BYTE</span> <span class="op">=</span><span class="op">&gt;</span> <span class="prelude-val">Ok</span>(<span class="ident"><span class="self">Self</span>::Bytes</span>),
            <span class="ident">PIPE_READMODE_MESSAGE</span> <span class="op">|</span> <span class="ident">PIPE_TYPE_MESSAGE</span> <span class="op">=</span><span class="op">&gt;</span> <span class="prelude-val">Ok</span>(<span class="ident"><span class="self">Self</span>::Messages</span>),
            <span class="kw">_</span> <span class="op">=</span><span class="op">&gt;</span> <span class="prelude-val">Err</span>(()),
        }
    }
}
</code></pre></div>
</section><section id="search" class="content hidden"></section><div id="rustdoc-vars" data-root-path="../../../../" data-current-crate="interprocess" data-search-index-js="../../../../search-index.js" data-search-js="../../../../search.js"></div>
    <script src="../../../../main.js"></script><script src="../../../../source-script.js"></script><script src="../../../../source-files.js"></script>
</body></html>